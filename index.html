<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Black Cat's Midnight Picnic</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom scrollbar hiding */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        body {
            background-color: #020617; /* Slate 950 */
            color: #e2e8f0; /* Slate 200 */
            overscroll-behavior: none; /* Prevent pull-to-refresh on mobile */
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }
        .star {
            animation: twinkle 3s infinite ease-in-out;
        }
        .pixel-art {
            image-rendering: pixelated;
        }
        @keyframes bloom {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- ICONS (Inline SVGs) ---
        const IconBase = ({ children, size = 24, className = "", fill = "none" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill={fill} 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {children}
            </svg>
        );

        const Heart = (props) => <IconBase {...props}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" /></IconBase>;
        const Music = (props) => <IconBase {...props}><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></IconBase>;
        const Star = (props) => <IconBase {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconBase>;
        const Tent = (props) => <IconBase {...props}><path d="M3.5 21 14 3"/><path d="M20.5 21 10 3"/><path d="M15.5 21 12 15l-3.5 6"/><path d="M2 21h20"/></IconBase>;
        const Cat = ({ size = 24, className = "" }) => <div className={`flex items-center justify-center ${className}`} style={{ width: size, height: size, fontSize: size * 0.8, lineHeight: 1 }}>üêà‚Äç‚¨õ</div>;
        const Coffee = (props) => <IconBase {...props}><path d="M10 2v2"/><path d="M14 2v2"/><path d="M16 8a1 1 0 0 1 1 1v8a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V9a1 1 0 0 1 1-1h14a4 4 0 1 1 0 8h-1"/><path d="M6 2v2"/></IconBase>;
        const X = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const Play = (props) => <IconBase {...props}><polygon points="5 3 19 12 5 21 5 3"/></IconBase>;
        const Pause = (props) => <IconBase {...props}><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></IconBase>;
        const Zap = (props) => <IconBase {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>;
        const Timer = (props) => <IconBase {...props}><line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/><circle cx="12" cy="14" r="8"/></IconBase>;
        const Trophy = (props) => <IconBase {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconBase>;
        const RefreshCw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>;
        const MapIcon = (props) => <IconBase {...props}><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></IconBase>;
        const Book = (props) => <IconBase {...props}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></IconBase>;
        const Settings = (props) => <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const Sword = (props) => <IconBase {...props}><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" x2="19" y1="19" y2="13"/><line x1="16" x2="20" y1="16" y2="20"/><line x1="19" x2="21" y1="21" y2="19"/></IconBase>;

        // --- ASSETS & CONFIG ---
        const GAME_ITEMS = [
            { type: 'good', emoji: 'üçî', value: 10, label: 'Burger' },
            { type: 'good', emoji: 'üçó', value: 10, label: 'Chicken Leg' },
            { type: 'good', emoji: 'ü™º', value: 10, label: 'Jellyfish' },
            { type: 'bonus', emoji: 'üßã', value: 50, label: 'Bubble Tea' },
            { type: 'good', emoji: 'üç™', value: 5, label: 'Soft Cookie' },
            { type: 'good', emoji: 'üëÖ', value: 10, label: 'Tongue' },
            { type: 'good', emoji: 'üßé', value: 10, label: 'Kneeling' },
            { type: 'good', emoji: 'üçë', value: 10, label: 'Nectarine' },
            { type: 'good', emoji: 'üçÜ', value: 10, label: 'Eggplant' },
            { type: 'good', emoji: 'üßÑ', value: 10, label: 'Garlic' },
            { type: 'good', emoji: '‚õ∫', value: 10, label: 'Tent' },
            { type: 'bad', emoji: 'ü•Ä', value: -10, label: 'Wilted Flower' },
            { type: 'bad', emoji: 'ü¶ë', value: -15, label: 'Calamari' },
            { type: 'bad', emoji: '‚õàÔ∏è', value: -20, label: 'Bad Weather' },
            { type: 'bad', emoji: 'ü¶†', value: -15, label: 'Germ' },
            { type: 'bad', emoji: '‚ôÇÔ∏è', value: -20, label: 'Men' },
        ];

        const LEVEL_CONFIG = [
            { level: 1, target: 50, time: 30, speed: 4, spawnRate: 0.03, title: "Warm Up" },
            { level: 2, target: 100, time: 30, speed: 5, spawnRate: 0.04, title: "Getting Hungry" },
            { level: 3, target: 150, time: 35, speed: 6, spawnRate: 0.05, title: "Midnight Snack" },
            { level: 4, target: 200, time: 40, speed: 7, spawnRate: 0.06, title: "Fast Food" },
            { level: 5, target: 250, time: 45, speed: 8, spawnRate: 0.08, title: "The Fiercest Hunt" },
        ];

        const MUSIC_POOL = [
            "2TjdnqlpwOjhijHCwHCP2d", "4W3tM5eY5a7Xy2h8W2Lz2a", "4g2c7NoTWAOSYDy44l9nhs", "6pnwfWyaWjQiHCKTiZLItr",
            "6mFqo63z1jD5U7aF7X4x6Z", "2ctvdKmETyOzPb2GiJJT53", "05uGBKRCuePsf43Hfm0JwX", "1tpcE1Ujav8q4fJgJMW4kb",
            "00hbwu3tPnbiH5MNjzF14N", "3rBCyn5i76CRYE5theSiB5", "7jhyoVX7uqGLLnoEvSSSnY", "1cQ4zuzVnux91bI1tJR1G7",
            "70LpDqsreV4MtlQzyyV87G", "5Od7Y3ihqhynfNBL10GS1V", "42wkMrkIqX4pYIGnTW70kG", "6ucNZBkwkPmw8OHiv5L7P4",
            "7Gi8jg3h2Ac0gMetpQUXmh", "0H2zA6m04MUsu4mX2KecNr", "6XHikJpK06NoXaFwkH4tPL", "2HcMkGeghyXdJRT1g85u0t",
            "6R2YSITVeRTFwDczaxSnQS", "4zGub7d71FopcEXaLKqxcU", "1ixXNc8iCkRniJhICf9xpy", "4l38jp3bDPcI5avo9ov482",
            "3WSaGTmm67vd3stVi0Zu9D"
        ];

        const DECORATION_ITEMS = [
            '‚òï', 'üïØÔ∏è', 'ü™¥', 'üìö', 'üß∏', 'üéß', 'üß∂', 'üåµ', 'üîÆ', 'üñºÔ∏è', 'üêà‚Äç‚¨õ', 'üçë', 'üåô', '‚ú®',
            'üßÅ', 'üçì', 'üéÄ', 'üéπ', 'üéª', 'üé∑', 'üé®', 'üöÄ', 'üõ∏', 'ü™ê', 'üè∞', 'üé°', 'üß∏', 'ü•ê', 'ü•û',
            'üíê', 'üç´', 'üç©', 'üç™', 'üç¨', 'üç≠', 'üçÆ', 'üçØ', 'üçº', 'ü•õ', 'üßÉ', 'üßâ', 'üßä'
        ];

        // --- COMPONENTS ---

        const StarBackground = () => {
            const [stars, setStars] = useState([]);
            useEffect(() => {
                const s = [];
                for(let i=0; i<50; i++) {
                    s.push({
                        top: Math.random() * 100,
                        left: Math.random() * 100,
                        size: Math.random() * 3,
                        delay: Math.random() * 2,
                        duration: Math.random() * 3 + 2
                    });
                }
                setStars(s);
            }, []);

            return (
                <div className="fixed inset-0 overflow-hidden pointer-events-none z-0">
                    {stars.map((s, i) => (
                        <div
                            key={i}
                            className="absolute bg-white rounded-full opacity-70 star"
                            style={{
                                top: `${s.top}%`,
                                left: `${s.left}%`,
                                width: `${s.size}px`,
                                height: `${s.size}px`,
                                animationDuration: `${s.duration}s`,
                                animationDelay: `${s.delay}s`
                            }}
                        />
                    ))}
                </div>
            );
        };

        // --- PICNIC GAME COMPONENT (Kept as is) ---
        const PicnicGame = ({ onGameOver }) => {
            const [gameState, setGameState] = useState('start');
            const [currentLevelIdx, setCurrentLevelIdx] = useState(0);
            const [score, setScore] = useState(0);
            const [timeLeft, setTimeLeft] = useState(0);
            const itemsRef = useRef([]);
            const floatingTextsRef = useRef([]);
            const playerPosRef = useRef(50);
            const scoreRef = useRef(0);
            const playerDomRef = useRef(null);
            const requestRef = useRef();
            const lastTimeRef = useRef(0);
            const [items, setItems] = useState([]);
            const [floatingTexts, setFloatingTexts] = useState([]);
            const [playerPos, setPlayerPos] = useState(50); 
            const currentLevelConfig = LEVEL_CONFIG[currentLevelIdx];
            const resetLevel = () => { itemsRef.current = []; floatingTextsRef.current = []; scoreRef.current = 0; setScore(0); setItems([]); setFloatingTexts([]); setTimeLeft(currentLevelConfig.time); setGameState('playing'); lastTimeRef.current = Date.now(); };
            const spawnItem = (spawnRate) => { if (Math.random() > spawnRate) return; const randomItem = GAME_ITEMS[Math.floor(Math.random() * GAME_ITEMS.length)]; const newItem = { id: Date.now() + Math.random(), x: Math.random() * (window.innerWidth - 50), y: -60, width: 40, height: 40, ...randomItem }; itemsRef.current.push(newItem); };
            const handleInput = (clientX) => { const width = window.innerWidth; const pos = (clientX / width) * 100; const clampedPos = Math.min(Math.max(pos, 5), 95); playerPosRef.current = clampedPos; setPlayerPos(clampedPos); };
            useEffect(() => { if (gameState !== 'playing') return; const gameLoop = () => { const now = Date.now(); const dt = now - lastTimeRef.current; if (dt >= 1000) { setTimeLeft(prev => { const newTime = prev - 1; if (newTime <= 0) return 0; return newTime; }); lastTimeRef.current = now; } if (scoreRef.current >= currentLevelConfig.target) { setGameState(currentLevelIdx === LEVEL_CONFIG.length - 1 ? 'victory' : 'level_complete'); cancelAnimationFrame(requestRef.current); return; } const currentItems = itemsRef.current; const currentFloatingTexts = floatingTextsRef.current; const nextItems = []; const nextFloatingTexts = []; let scoreDelta = 0; let playerRect = { x: 0, y: 0, width: 0, height: 0 }; if (playerDomRef.current) { const rect = playerDomRef.current.getBoundingClientRect(); playerRect = { x: rect.x + 10, y: rect.y + 10, width: rect.width - 20, height: rect.height - 20 }; } currentFloatingTexts.forEach(ft => { ft.y -= 2; ft.life -= 1; if (ft.life > 0) nextFloatingTexts.push(ft); }); currentItems.forEach(item => { item.y += currentLevelConfig.speed; const itemRect = { x: item.x, y: item.y, width: 30, height: 30 }; const isColliding = itemRect.x < playerRect.x + playerRect.width && itemRect.x + itemRect.width > playerRect.x && itemRect.y < playerRect.y + playerRect.height && itemRect.y + itemRect.height > playerRect.y; if (isColliding) { scoreDelta += item.value; nextFloatingTexts.push({ id: Date.now() + Math.random(), x: item.x, y: item.y, text: item.value > 0 ? `+${item.value}` : `${item.value}`, color: item.value > 0 ? 'text-green-400' : 'text-red-400', life: 40 }); } else if (item.y < window.innerHeight) { nextItems.push(item); } }); itemsRef.current = nextItems; floatingTextsRef.current = nextFloatingTexts; setItems([...nextItems]); setFloatingTexts([...nextFloatingTexts]); if (scoreDelta !== 0) { scoreRef.current += scoreDelta; setScore(scoreRef.current); } spawnItem(currentLevelConfig.spawnRate); requestRef.current = requestAnimationFrame(gameLoop); }; lastTimeRef.current = Date.now(); requestRef.current = requestAnimationFrame(gameLoop); return () => cancelAnimationFrame(requestRef.current); }, [gameState, currentLevelConfig]);
            useEffect(() => { if (gameState === 'playing' && timeLeft === 0) { setGameState('failed'); } }, [timeLeft, gameState]);
            const renderOverlay = () => { if (gameState === 'playing') return null; let title = "", message = "", buttonText = "", onButtonClick = null, extraContent = null; switch (gameState) { case 'start': title = "Midnight Picnic Challenge"; message = "Are you ready to feed the Black Kitten (you)?"; buttonText = "Start Level 1"; onButtonClick = resetLevel; extraContent = (<div className="mt-4 text-sm text-pink-300 bg-black/40 p-3 rounded"><div>Level 1 Goal:</div><div className="font-bold text-white text-lg">{LEVEL_CONFIG[0].target} points in {LEVEL_CONFIG[0].time}s</div></div>); break; case 'level_complete': title = "Delicious!"; message = `Level ${currentLevelIdx + 1} Complete!`; buttonText = `Start Level ${currentLevelIdx + 2}`; onButtonClick = () => { if (currentLevelIdx < LEVEL_CONFIG.length - 1) { setCurrentLevelIdx(prev => prev + 1); setTimeout(() => { const nextLvl = LEVEL_CONFIG[currentLevelIdx + 1]; itemsRef.current = []; scoreRef.current = 0; setScore(0); setTimeLeft(nextLvl.time); setGameState('playing'); lastTimeRef.current = Date.now(); }, 50); } }; break; case 'failed': title = "Oh no! Too Slow!"; message = `You didn't eat enough. The kitten is still hungry.`; buttonText = "Try Level Again"; onButtonClick = resetLevel; break; case 'victory': return (<div className="absolute inset-0 flex items-center justify-center z-50 bg-black/90 backdrop-blur-md animate-in fade-in duration-1000"><div className="max-w-md w-full p-8 border-4 border-pink-500 rounded-3xl bg-slate-900 text-center relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-full bg-pink-500/10 animate-pulse"></div><div className="w-24 h-24 mx-auto bg-gradient-to-br from-pink-400 to-purple-600 rounded-full flex items-center justify-center mb-6 shadow-[0_0_30px_rgba(236,72,153,0.8)]"><Cat size={48} className="text-white" /></div><h2 className="text-4xl font-serif text-transparent bg-clip-text bg-gradient-to-r from-pink-300 via-purple-300 to-white mb-6 font-bold">Congratulations!</h2><div className="bg-white/5 p-6 rounded-xl border border-pink-500/30 backdrop-blur-sm mb-8 transform hover:scale-105 transition-transform"><Heart className="w-8 h-8 text-red-500 mx-auto mb-4 animate-bounce" fill="currentColor" /><p className="text-xl text-pink-100 font-serif italic leading-relaxed">"You're the fiercest black cat."</p></div><button onClick={() => { setCurrentLevelIdx(0); setGameState('start'); }} className="text-slate-400 hover:text-white text-sm underline">Play Again</button></div></div>); default: return null; } return (<div className="absolute inset-0 flex items-center justify-center z-30 bg-black/80 backdrop-blur-sm animate-in zoom-in-95 duration-300"><div className="text-center p-8 border-2 border-pink-500 rounded-2xl bg-slate-900 shadow-[0_0_20px_rgba(236,72,153,0.5)] max-w-sm w-full mx-4"><h2 className="text-3xl font-bold text-pink-400 mb-2">{title}</h2><p className="text-slate-300 mb-6">{message}</p>{extraContent}<div className="flex justify-center gap-4 mb-6 text-2xl"><span>üçë</span><span>üç™</span><span>üßã</span></div><button onClick={onButtonClick} className="w-full px-8 py-3 bg-pink-600 hover:bg-pink-500 text-white rounded-full font-bold transition-all transform hover:scale-105 shadow-lg shadow-pink-500/30">{buttonText}</button></div></div>); };
            return ( <div className="relative w-full h-full touch-none overflow-hidden cursor-none" onTouchMove={(e) => handleInput(e.touches[0].clientX)} onMouseMove={(e) => handleInput(e.clientX)}> <div className="absolute top-4 left-4 right-4 z-20 flex justify-between items-start pointer-events-none"> <div className="flex flex-col gap-2"> <div className="text-yellow-300 font-mono text-sm font-bold bg-black/60 p-2 rounded border border-yellow-500/30 flex items-center gap-2 w-fit"><Zap size={14} /> LEVEL {currentLevelIdx + 1}</div> <div className="text-pink-300 font-mono text-lg font-bold bg-black/60 p-2 rounded border border-pink-500/30 flex items-center gap-2 w-fit"><Trophy size={16} /> <span>{score} / {currentLevelConfig.target}</span></div> </div> <div className={`font-mono text-2xl font-bold bg-black/60 p-3 rounded-xl border flex items-center gap-2 ${timeLeft < 10 ? 'text-red-500 border-red-500 animate-pulse' : 'text-white border-slate-500'}`}><Timer size={24} /> {timeLeft}s</div> </div> {renderOverlay()} {items.map(item => (<div key={item.id} className="absolute text-4xl pointer-events-none" style={{ left: item.x, top: item.y }}>{item.emoji}</div>))} {floatingTexts.map(ft => (<div key={ft.id} className={`absolute text-2xl font-black pointer-events-none ${ft.color} drop-shadow-md`} style={{ left: ft.x, top: ft.y, opacity: ft.life / 40, transform: `translateY(-${(40 - ft.life)}px)` }}>{ft.text}</div>))} <div ref={playerDomRef} className="absolute bottom-24 text-6xl transform -translate-x-1/2 transition-transform duration-75 pointer-events-none drop-shadow-[0_0_15px_rgba(255,255,255,0.4)]" style={{ left: `${playerPos}%` }}>üêà‚Äç‚¨õ</div> <div className="absolute bottom-0 w-full h-24 bg-gradient-to-t from-slate-900 to-transparent flex justify-around items-end pb-4 opacity-50 pointer-events-none"><Tent className="text-slate-600 w-12 h-12" /><div className="text-slate-600">üî•</div><Tent className="text-slate-600 w-12 h-12" /></div> </div> );
        };

        // --- RPG MINI-GAME COMPONENT ---
        const RPGGame = ({ onFinish }) => {
            const MAP_COLS = 12;
            const MAP_ROWS = 12;
            const INITIAL_MISSIONS = [{ id: 1, text: "Collect 4 Nectarines", type: 'collect', target: 'üçë', current: 0, required: 4, completed: false }, { id: 2, text: "Defeat 3 Enemies", type: 'defeat', target: 'any', current: 0, required: 3, completed: false }, { id: 3, text: "Reach Level 3", type: 'level', target: 'lvl', current: 1, required: 3, completed: false }, { id: 4, text: "Defeat the Calamari King", type: 'defeat', target: 'Calamari', current: 0, required: 1, completed: false }, { id: 5, text: "Eat a Cookie", type: 'collect', target: 'üç™', current: 0, required: 1, completed: false }];
            
            const [player, setPlayer] = useState({ x: 1, y: 1, hp: 50, maxHp: 50, xp: 0, level: 1, attack: 10 });
            const [mapGrid, setMapGrid] = useState([]);
            const [entities, setEntities] = useState([]);
            const [missions, setMissions] = useState(INITIAL_MISSIONS);
            const [gameState, setGameState] = useState('roaming');
            const [battleState, setBattleState] = useState(null);
            const [message, setMessage] = useState("Welcome to the Adventure!");

            useEffect(() => { generateMap(); }, []);

            const generateMap = () => {
                const grid = [];
                const newEntities = [];
                let id = 0;
                // Generate Grid with safe zone around spawn (1,1)
                for(let y=0; y<MAP_ROWS; y++) {
                    for(let x=0; x<MAP_COLS; x++) {
                        const cell = { x, y, isObstacle: false, decoration: null };
                        // Edges are walls
                        if (x === 0 || x === MAP_COLS-1 || y === 0 || y === MAP_ROWS-1) {
                            cell.isObstacle = true; cell.decoration = 'üå≤';
                        } else {
                            // Safe zone check: don't spawn obstacles at (1,1) or neighbors (1,2) and (2,1)
                            const isSafeZone = (x===1 && y===1) || (x===1 && y===2) || (x===2 && y===1);
                            if (!isSafeZone && Math.random() < 0.15) {
                                cell.isObstacle = true;
                                cell.decoration = Math.random() > 0.5 ? 'ü™®' : 'üå≤';
                            } else {
                                if (Math.random() > 0.8) cell.decoration = 'üå±';
                                if (Math.random() > 0.9) cell.decoration = 'üåø';
                            }
                        }
                        grid.push(cell);
                    }
                }
                setMapGrid(grid);

                // Helper to get free coord avoiding safe zone for entities too (optional, but good for balance)
                const getFreeCoord = () => {
                    let tries = 0;
                    while(tries < 100) {
                        const x = Math.floor(Math.random() * (MAP_COLS - 2)) + 1;
                        const y = Math.floor(Math.random() * (MAP_ROWS - 2)) + 1;
                        const idx = y * MAP_COLS + x;
                        const isSafe = (x===1 && y===1); // Just don't spawn ON player
                        if (!grid[idx].isObstacle && !isSafe && !newEntities.find(e => e.x===x && e.y===y)) {
                            return { x, y };
                        }
                        tries++;
                    }
                    return { x: 3, y: 3 }; 
                };

                for(let i=0; i<6; i++) { const pos = getFreeCoord(); newEntities.push({ id: id++, ...pos, type: 'item', content: 'üçë', name: 'Nectarine', value: 10 }); }
                for(let i=0; i<3; i++) { const pos = getFreeCoord(); newEntities.push({ id: id++, ...pos, type: 'item', content: 'üç™', name: 'Cookie', value: 5 }); }
                const villainTypes = [{ content: '‚õàÔ∏è', name: 'Bad Vibe', hp: 30, xp: 40 }, { content: 'ü¶†', name: 'Germ', hp: 20, xp: 25 }, { content: 'ü•Ä', name: 'Wilted Flower', hp: 25, xp: 30 }, { content: 'ü¶ë', name: 'Calamari', hp: 50, xp: 100 }];
                for(let i=0; i<6; i++) { const pos = getFreeCoord(); const type = (i === 0) ? villainTypes[3] : villainTypes[Math.floor(Math.random() * 3)]; newEntities.push({ id: id++, ...pos, type: 'enemy', ...type, maxHp: type.hp, attack: 5 }); }
                setEntities(newEntities);
            };

            // ... (Rest of RPG logic logic remains mostly same, simplified for brevity in this block) ...
            const updateMission = (type, target, amount = 1) => { setMissions(prev => { const next = prev.map(m => { if (m.completed) return m; if (m.type === type) { if (type === 'collect' && target === m.target) { return { ...m, current: Math.min(m.current + amount, m.required) }; } if (type === 'defeat') { if (m.target === 'any' || m.target === target) { return { ...m, current: Math.min(m.current + amount, m.required) }; } } if (type === 'level') { return { ...m, current: Math.max(m.current, amount) }; } } return m; }); return next.map(m => ({ ...m, completed: m.current >= m.required })); }); };
            useEffect(() => { if (missions.every(m => m.completed) && gameState !== 'victory') { setGameState('victory'); } }, [missions, gameState]);
            const movePlayer = (dx, dy) => { if (gameState !== 'roaming') return; const newX = player.x + dx; const newY = player.y + dy; if (newX < 0 || newX >= MAP_COLS || newY < 0 || newY >= MAP_ROWS) return; const targetCell = mapGrid[newY * MAP_COLS + newX]; if (targetCell && targetCell.isObstacle) { setMessage("Bonk! Something blocks the way."); return; } const entityIndex = entities.findIndex(e => e.x === newX && e.y === newY); if (entityIndex >= 0) { const entity = entities[entityIndex]; if (entity.type === 'item') { setMessage(`Found ${entity.name}!`); if (entity.name === 'Cookie') { setPlayer(p => ({ ...p, hp: Math.min(p.hp + 20, p.maxHp) })); updateMission('collect', 'üç™', 1); setMessage("Ate a cookie! HP recovered."); } else { updateMission('collect', entity.content, 1); } const newEnts = [...entities]; newEnts.splice(entityIndex, 1); setEntities(newEnts); setPlayer(prev => ({ ...prev, x: newX, y: newY })); } else if (entity.type === 'enemy') { setBattleState({ enemy: { ...entity, index: entityIndex }, log: [`A wild ${entity.name} appeared!`] }); setGameState('battle'); } } else { setPlayer(prev => ({ ...prev, x: newX, y: newY })); } };
            const battleAction = (action) => { if (!battleState) return; const { enemy } = battleState; let newEnemyHp = enemy.hp; let newPlayerHp = player.hp; let newLog = [...battleState.log]; if (action === 'attack') { const dmg = player.attack + Math.floor(Math.random() * 5); newEnemyHp -= dmg; newLog.push(`You scratched for ${dmg} damage!`); } else if (action === 'hiss') { const dmg = player.attack * 1.5; newEnemyHp -= dmg; newLog.push(`You HISS loudly! ${dmg} damage!`); } else if (action === 'heal') { const heal = 15; newPlayerHp = Math.min(newPlayerHp + heal, player.maxHp); newLog.push(`You purred and healed ${heal} HP.`); } if (newEnemyHp <= 0) { newLog.push(`Defeated ${enemy.name}! +${enemy.xp} XP`); const newXp = player.xp + enemy.xp; let newLevel = player.level; if (newXp >= 100 * player.level) { newLevel += 1; newLog.push(`Leveled Up! You are now level ${newLevel}!`); updateMission('level', 'lvl', newLevel); } setPlayer(p => ({ ...p, hp: newPlayerHp, xp: newXp, level: newLevel, maxHp: 50 + (newLevel-1)*10, attack: 10 + (newLevel-1)*5 })); const newEnts = [...entities]; newEnts.splice(enemy.index, 1); setEntities(newEnts); updateMission('defeat', enemy.name, 1); updateMission('defeat', 'any', 1); setTimeout(() => { setGameState('roaming'); setBattleState(null); setMessage("Victory! Back to exploring..."); }, 1500); } else { const enemyDmg = Math.max(0, enemy.attack + Math.floor(Math.random() * 3) - (player.level)); newPlayerHp -= enemyDmg; newLog.push(`${enemy.name} attacked you for ${enemyDmg} damage.`); if (newPlayerHp <= 0) { newLog.push("You fainted! Respawning..."); setTimeout(() => { setPlayer(p => ({ ...p, x: 1, y: 1, hp: p.maxHp })); setGameState('roaming'); setBattleState(null); setMessage("Be careful next time!"); }, 2000); } } setPlayer(p => ({ ...p, hp: newPlayerHp })); setBattleState(prev => ({ ...prev, enemy: { ...prev.enemy, hp: newEnemyHp }, log: newLog.slice(-4) })); };

            return (
                <div className="h-full flex flex-col items-center justify-center p-2 bg-slate-900 relative w-full">
                    {/* Compact HUD */}
                    <div className="w-full max-w-md flex justify-between items-center mb-2 bg-slate-800 p-2 rounded-lg border border-pink-500/30 text-xs">
                        <div className="flex flex-col">
                            <span className="text-pink-300 font-bold">LVL {player.level}</span>
                            <div className="w-20 h-1.5 bg-slate-700 rounded-full mt-1">
                                <div className="h-full bg-green-500 rounded-full" style={{width: `${(player.hp/player.maxHp)*100}%`}}></div>
                            </div>
                        </div>
                        <div className="text-slate-400 text-right truncate ml-2">
                            {missions.filter(m => !m.completed).length > 0 ? 
                                `Quest: ${missions.find(m => !m.completed)?.text}` : "All Done!"}
                        </div>
                    </div>

                    {/* Flexible Game Viewport */}
                    <div className="relative w-full max-w-md bg-emerald-900 rounded-xl border-4 border-slate-700 overflow-hidden shadow-2xl flex-shrink-1 aspect-square max-h-[50vh]">
                        {/* Map Grid */}
                        {gameState === 'roaming' && (
                            <div className="absolute inset-0 grid" style={{ 
                                gridTemplateColumns: `repeat(${MAP_COLS}, 1fr)`, 
                                gridTemplateRows: `repeat(${MAP_ROWS}, 1fr)` 
                            }}>
                                {mapGrid.map((cell, i) => (
                                    <div key={i} className={`border-[0.5px] border-white/5 relative flex items-center justify-center ${cell.isObstacle ? 'bg-slate-800/50' : 'bg-green-800/40'}`}>
                                        {cell.decoration && <span style={{fontSize: 'clamp(8px, 1.5vw, 16px)'}} className="opacity-70">{cell.decoration}</span>}
                                    </div>
                                ))}

                                {entities.map(e => (
                                    <div key={e.id} className="absolute flex items-center justify-center transition-all duration-300 transform hover:scale-110 z-10"
                                         style={{ 
                                             width: `${100/MAP_COLS}%`, height: `${100/MAP_ROWS}%`,
                                             left: `${(e.x/MAP_COLS)*100}%`, top: `${(e.y/MAP_ROWS)*100}%`,
                                             fontSize: 'clamp(12px, 2.5vw, 24px)'
                                         }}>
                                        {e.content}
                                    </div>
                                ))}

                                <div className="absolute flex items-center justify-center transition-all duration-200 z-20"
                                     style={{ 
                                         width: `${100/MAP_COLS}%`, height: `${100/MAP_ROWS}%`,
                                         left: `${(player.x/MAP_COLS)*100}%`, top: `${(player.y/MAP_ROWS)*100}%`,
                                         fontSize: 'clamp(14px, 3vw, 28px)'
                                     }}>
                                    üêà‚Äç‚¨õ
                                </div>
                            </div>
                        )}

                        {gameState === 'battle' && battleState && (
                            <div className="absolute inset-0 bg-slate-900/95 flex flex-col items-center justify-center p-4 animate-in fade-in z-30">
                                <h3 className="text-xl font-bold text-red-400 mb-4 animate-pulse">BATTLE!</h3>
                                
                                <div className="flex justify-around w-full mb-4">
                                    <div className="text-center">
                                        <div className="text-3xl mb-1">üêà‚Äç‚¨õ</div>
                                        <div className="text-xs font-bold text-green-400">{player.hp} HP</div>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-3xl mb-1 animate-bounce">{battleState.enemy.content}</div>
                                        <div className="text-xs font-bold text-red-400">{battleState.enemy.hp} HP</div>
                                    </div>
                                </div>

                                <div className="w-full bg-black/50 p-2 rounded mb-4 h-20 overflow-y-auto text-[10px] font-mono text-slate-300 border border-slate-700">
                                    {battleState.log.map((l, i) => <div key={i}>{l}</div>)}
                                </div>

                                <div className="grid grid-cols-2 gap-2 w-full text-xs">
                                    <button onClick={() => battleAction('attack')} className="p-2 bg-red-600 rounded font-bold hover:bg-red-500 flex items-center justify-center gap-1"><Sword size={12} /> Scratch</button>
                                    <button onClick={() => battleAction('hiss')} className="p-2 bg-orange-600 rounded font-bold hover:bg-orange-500 flex items-center justify-center gap-1"><Zap size={12}/> Hiss</button>
                                    <button onClick={() => battleAction('heal')} className="p-2 bg-green-600 rounded font-bold hover:bg-green-500 col-span-2 flex items-center justify-center gap-1"><Heart size={12} /> Purr</button>
                                </div>
                            </div>
                        )}

                        {gameState === 'victory' && (
                            <div className="absolute inset-0 bg-pink-900/90 flex flex-col items-center justify-center p-6 text-center animate-in zoom-in z-40">
                                <Trophy size={48} className="text-yellow-400 mb-2" />
                                <h2 className="text-2xl font-bold text-white mb-2">Adventure Complete!</h2>
                                <p className="text-pink-200 text-sm mb-4">You've cleared all challenges.</p>
                            </div>
                        )}
                    </div>

                    {/* Compact Controls */}
                    {gameState === 'roaming' && (
                        <div className="mt-2 w-full max-w-md flex flex-col items-center gap-2">
                             <div className="text-pink-300 font-mono text-xs h-4 overflow-hidden w-full text-center">
                                {message}
                            </div>
                            <div className="grid grid-cols-3 gap-1">
                                <div></div>
                                <button onClick={() => movePlayer(0, -1)} className="w-12 h-12 bg-slate-700 rounded-lg active:bg-pink-500 transition-colors flex items-center justify-center text-xl shadow-lg border border-slate-600">‚¨ÜÔ∏è</button>
                                <div></div>
                                <button onClick={() => movePlayer(-1, 0)} className="w-12 h-12 bg-slate-700 rounded-lg active:bg-pink-500 transition-colors flex items-center justify-center text-xl shadow-lg border border-slate-600">‚¨ÖÔ∏è</button>
                                <div className="flex items-center justify-center"><div className="w-2 h-2 bg-pink-500/50 rounded-full"></div></div>
                                <button onClick={() => movePlayer(1, 0)} className="w-12 h-12 bg-slate-700 rounded-lg active:bg-pink-500 transition-colors flex items-center justify-center text-xl shadow-lg border border-slate-600">‚û°Ô∏è</button>
                                <div></div>
                                <button onClick={() => movePlayer(0, 1)} className="w-12 h-12 bg-slate-700 rounded-lg active:bg-pink-500 transition-colors flex items-center justify-center text-xl shadow-lg border border-slate-600">‚¨áÔ∏è</button>
                                <div></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ConstellationIllustration = ({ title, icon, data }) => {
            const hasRealData = !!data;
            const seed = title.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const random = (offset = 0) => {
                const x = Math.sin(seed + offset) * 10000;
                return x - Math.floor(x);
            };

            let stars = [];
            let lines = [];

            if (hasRealData) {
                stars = data.stars;
                lines = data.lines;
            } else {
                const starCount = 5 + Math.floor(random(1) * 5);
                for(let i=0; i<starCount; i++) {
                    stars.push({
                        x: 15 + random(i * 2) * 70,
                        y: 15 + random(i * 2 + 1) * 70,
                        size: 2 + random(i * 3) * 2
                    });
                }
                const sortedStars = [...stars].sort((a,b) => a.x - b.x);
                for(let i=0; i<sortedStars.length-1; i++) {
                    lines.push({ x1: sortedStars[i].x, y1: sortedStars[i].y, x2: sortedStars[i+1].x, y2: sortedStars[i+1].y });
                }
                stars = sortedStars;
            }

            return (
                <div className="w-full h-64 bg-slate-950 rounded-2xl relative overflow-hidden mb-6 border-2 border-slate-700 shadow-inner group">
                    <div className="absolute inset-0 opacity-40 transition-opacity duration-1000" 
                            style={{
                                background: `radial-gradient(circle at ${random(10)*100}% ${random(11)*100}%, rgba(147, 51, 234, 0.3), transparent 60%),
                                            radial-gradient(circle at ${random(12)*100}% ${random(13)*100}%, rgba(236, 72, 153, 0.2), transparent 50%)`
                            }}
                    />
                    <div className="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none select-none grayscale contrast-150 transform scale-150 group-hover:scale-125 transition-transform duration-1000">
                        <span className="text-9xl filter blur-sm">{icon}</span>
                    </div>
                    <svg className="w-full h-full absolute inset-0 p-4 pointer-events-none">
                        {lines.map((line, i) => (
                            <line 
                                key={i}
                                x1={`${line.x1}%`} y1={`${line.y1}%`}
                                x2={`${line.x2}%`} y2={`${line.y2}%`}
                                stroke="rgba(255,255,255,0.4)"
                                strokeWidth="1.5"
                                strokeDasharray="5,5"
                                className="animate-pulse"
                                style={{ animationDuration: '3s' }}
                            />
                        ))}
                        {stars.map((s, i) => (
                            <circle 
                                key={i} 
                                cx={`${s.x}%`} 
                                cy={`${s.y}%`} 
                                r={s.size || (3 + random(i)*2)} 
                                fill="white" 
                                className="drop-shadow-[0_0_4px_rgba(255,255,255,0.8)]"
                            >
                                <animate attributeName="opacity" values="0.5;1;0.5" dur={`${2 + random(i)}s`} repeatCount="indefinite" />
                            </circle>
                        ))}
                    </svg>
                    <div className="absolute bottom-2 right-4 text-xs text-slate-500 font-mono opacity-50">
                        {hasRealData ? "ASTRONOMICAL DATA" : `ARTISTIC REP. FIG. ${seed % 100}`}
                    </div>
                </div>
            )
        }

        const ConstellationGallery = () => {
            const [activeConstellation, setActiveConstellation] = useState(null);
            const [currentTracks, setCurrentTracks] = useState([]);
            const [currentConstellations, setCurrentConstellations] = useState([]);

            const allConstellations = [
                { 
                    id: 1, icon: 'üèπ', title: 'Orion', 
                    text: 'The Hunter. Famous for his belt of three stars. Battling Taurus in the winter sky.',
                    data: {
                        stars: [{x: 25, y: 20, size: 4}, {x: 75, y: 25, size: 4}, {x: 45, y: 50, size: 3}, {x: 50, y: 50, size: 3}, {x: 55, y: 50, size: 3}, {x: 30, y: 80, size: 4}, {x: 70, y: 85, size: 5}],
                        lines: [{x1: 25, y1: 20, x2: 45, y2: 50}, {x1: 75, y1: 25, x2: 55, y2: 50}, {x1: 45, y1: 50, x2: 50, y2: 50}, {x1: 50, y1: 50, x2: 55, y2: 50}, {x1: 45, y1: 50, x2: 30, y2: 80}, {x1: 55, y1: 50, x2: 70, y2: 85}]
                    }
                },
                { 
                    id: 2, icon: 'üêª', title: 'Ursa Major', 
                    text: 'The Great Bear (Big Dipper). Use the pointer stars to find the North Star.',
                    data: {
                        stars: [{x: 10, y: 30, size: 3}, {x: 25, y: 25, size: 3}, {x: 35, y: 35, size: 3}, {x: 50, y: 45, size: 3}, {x: 75, y: 45, size: 3}, {x: 75, y: 70, size: 3}, {x: 50, y: 70, size: 3}],
                        lines: [{x1: 10, y1: 30, x2: 25, y2: 25}, {x1: 25, y1: 25, x2: 35, y2: 35}, {x1: 35, y1: 35, x2: 50, y2: 45}, {x1: 50, y1: 45, x2: 75, y2: 45}, {x1: 75, y1: 45, x2: 75, y2: 70}, {x1: 75, y1: 70, x2: 50, y2: 70}, {x1: 50, y1: 70, x2: 50, y2: 45}]
                    }
                },
                { 
                    id: 3, icon: 'üëë', title: 'Cassiopeia', 
                    text: 'The Queen. A distinctive "W" or "M" shape high in the northern sky.',
                    data: {
                        stars: [{x: 15, y: 30, size: 3}, {x: 35, y: 60, size: 3}, {x: 50, y: 40, size: 4}, {x: 65, y: 60, size: 3}, {x: 85, y: 30, size: 3}],
                        lines: [{x1: 15, y1: 30, x2: 35, y2: 60}, {x1: 35, y1: 60, x2: 50, y2: 40}, {x1: 50, y1: 40, x2: 65, y2: 60}, {x1: 65, y1: 60, x2: 85, y2: 30}]
                    }
                },
                { 
                    id: 4, icon: 'üêï', title: 'Canis Major', 
                    text: 'The Great Dog. Faithful companion to Orion. Home to Sirius, the brightest star.',
                    data: {
                        stars: [{x: 45, y: 30, size: 5}, {x: 55, y: 32, size: 3}, {x: 65, y: 55, size: 4}, {x: 60, y: 70, size: 3}, {x: 30, y: 60, size: 3}],
                        lines: [{x1: 45, y1: 30, x2: 65, y2: 55}, {x1: 45, y1: 30, x2: 55, y2: 32}, {x1: 65, y1: 55, x2: 60, y2: 70}, {x1: 65, y1: 55, x2: 30, y2: 60}]
                    }
                }
            ];
            const shuffleTracks = () => { const shuffled = [...MUSIC_POOL].sort(() => 0.5 - Math.random()); setCurrentTracks(shuffled.slice(0, 4)); };
            const shuffleConstellations = () => { const shuffled = [...allConstellations].sort(() => 0.5 - Math.random()); setCurrentConstellations(shuffled.slice(0, 4)); };
            useEffect(() => { shuffleTracks(); shuffleConstellations(); }, []);
            return ( <div className="p-6 max-w-2xl mx-auto pb-24"> <h2 className="text-3xl font-serif text-center text-pink-200 mb-8 border-b border-slate-700 pb-4"> You as a Constellation </h2> <div className="bg-slate-800/50 rounded-xl p-4 mb-8 border border-slate-700 backdrop-blur-sm relative overflow-hidden group"> <div className="absolute top-0 right-0 p-2 opacity-50 group-hover:opacity-100 transition-opacity z-10"> <button onClick={shuffleTracks} className="p-2 bg-black/40 hover:bg-pink-500 rounded-full transition-colors" title="Shuffle Songs"> <RefreshCw size={16} className="text-white" /> </button> </div> <div className="flex items-center gap-4 mb-4"> <div className="w-16 h-16 bg-gradient-to-br from-pink-500 to-purple-900 rounded-lg flex items-center justify-center animate-pulse"> <Music className="text-white w-8 h-8" /> </div> <div> <h3 className="text-white font-bold">Midnight Mixtape</h3> <p className="text-pink-400 text-sm">Vibes: Dark Side &amp; Summer Nights</p> </div> </div> <div className="space-y-3"> {currentTracks.map((trackId, i) => ( <iframe key={i} style={{ borderRadius: '12px' }} src={`https://open.spotify.com/embed/track/${trackId}?utm_source=generator&theme=0`} width="100%" height="80" frameBorder="0" allowFullScreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy" className="bg-slate-900" /> ))} </div> </div> <div className="flex justify-between items-center mb-4 px-2"> <h3 className="text-pink-200 font-bold text-lg">Star Map</h3> <button onClick={shuffleConstellations} className="p-2 bg-slate-800 hover:bg-pink-600/50 rounded-full transition-colors flex items-center gap-2 text-xs text-slate-400 hover:text-white"> <RefreshCw size={14} /> Shuffle Stars </button> </div> <div className="grid grid-cols-2 gap-4"> {currentConstellations.map((c) => ( <button key={c.id} onClick={() => setActiveConstellation(c)} className="p-4 bg-slate-800/80 rounded-xl border border-slate-700 hover:border-pink-500/50 transition-all hover:scale-105 text-left group"> <div className="text-3xl mb-2 group-hover:animate-bounce shadow-white drop-shadow-md">{c.icon}</div> <h3 className="text-pink-200 font-bold text-sm">{c.title}</h3> </button> ))} </div> {activeConstellation && ( <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4" onClick={() => setActiveConstellation(null)}> <div className="bg-slate-900 border border-pink-500 rounded-2xl p-6 max-w-sm w-full relative transform scale-100 transition-transform flex flex-col items-center"> <button className="absolute top-2 right-2 text-slate-500 hover:text-white z-10"><X size={20}/></button> <ConstellationIllustration title={activeConstellation.title} icon={activeConstellation.icon} data={activeConstellation.data} /> <h3 className="text-2xl font-serif font-bold text-pink-400 mb-2 text-center">{activeConstellation.title}</h3> <p className="text-slate-300 text-center leading-relaxed text-sm mb-4">{activeConstellation.text}</p> <div className="mt-2 text-center text-xs text-slate-600">Tap anywhere to close</div> </div> </div> )} </div> );
        };

        const LoveLetter = () => {
            // ... (Restored LoveLetter) ...
            return ( <div className="min-h-[60vh] flex flex-col items-center justify-center p-8 text-center animate-in fade-in duration-1000"> <div className="w-32 h-32 rounded-full overflow-hidden border-4 border-pink-500 shadow-[0_0_30px_rgba(236,72,153,0.6)] mb-8 bg-slate-800 flex items-center justify-center"> <span className="text-6xl">üñ§</span> </div> <h1 className="text-4xl font-serif text-white mb-6">For the hottest black pantheress</h1> <div className="max-w-md bg-white/5 backdrop-blur-md p-6 rounded-xl border border-white/10 text-lg leading-relaxed text-pink-100 font-serif italic"> <p> I can't get over your dark aesthetic, your obsession with nectarines, and the way you look at me when I say something you like. I melt everytime you whisper my name or say that you want me. Keep spiting on my face pls ü´† </p> </div> <div className="mt-8 text-sm text-slate-500 font-mono"> coded with ‚ù§Ô∏è by Banos </div> </div> );
        };

        // --- NEW COMPONENT: Stargazer Lily Visualization ---
        const StargazerLily = ({ progress }) => {
            // Scale increases as progress goes from 0 to 100
            // Opacity also fades in
            const scale = 0.2 + (progress / 100) * 0.8;
            const opacity = 0.5 + (progress / 100) * 0.5;
            
            return (
                <div 
                    className="relative w-48 h-48 flex items-center justify-center transition-all duration-1000 ease-out mb-6" 
                    style={{ 
                        transform: `scale(${scale})`, 
                        opacity: opacity 
                    }}
                >
                   <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-[0_0_15px_rgba(236,72,153,0.6)]">
                       {/* Petals - Pink with Dark Pink stroke */}
                       <g fill="#ec4899" stroke="#be185d" strokeWidth="1">
                           {/* Bottom Petal */}
                           <path d="M50 50 Q30 80 50 100 Q70 80 50 50" />
                           {/* Top Petal */}
                           <path d="M50 50 Q30 20 50 0 Q70 20 50 50" />
                           {/* Right Petal */}
                           <path d="M50 50 Q80 30 100 50 Q80 70 50 50" />
                           {/* Left Petal */}
                           <path d="M50 50 Q20 30 0 50 Q20 70 50 50" />
                           {/* Diagonals */}
                           <path d="M50 50 Q20 20 15 15 Q40 10 50 50" transform="rotate(45 50 50)" />
                           <path d="M50 50 Q80 80 85 85 Q60 90 50 50" transform="rotate(45 50 50)" />
                       </g>
                       {/* Spots - Stargazer lilies have spots */}
                       <g fill="#be185d">
                           <circle cx="50" cy="40" r="1.5" />
                           <circle cx="50" cy="30" r="1.5" />
                           <circle cx="60" cy="50" r="1.5" />
                           <circle cx="70" cy="50" r="1.5" />
                           <circle cx="40" cy="50" r="1.5" />
                           <circle cx="30" cy="50" r="1.5" />
                           <circle cx="50" cy="60" r="1.5" />
                           <circle cx="50" cy="70" r="1.5" />
                       </g>
                       {/* Center - Yellow/Green Stamen */}
                       <circle cx="50" cy="50" r="6" fill="#facc15" stroke="#a16207" />
                       <path d="M50 50 L40 40 M50 50 L60 40 M50 50 L40 60 M50 50 L60 60" stroke="#facc15" strokeWidth="2" strokeLinecap="round" />
                   </svg>
                </div>
            )
        }

        // --- UPDATED COMPONENT: POMODORO TIMER & STUDY ROOM ---
        const Pomodoro = () => {
            const [timeLeft, setTimeLeft] = useState(25 * 60);
            const [isActive, setIsActive] = useState(false);
            const [mode, setMode] = useState('focus'); // 'focus' or 'break'
            const [cycle, setCycle] = useState(0);
            const [decorations, setDecorations] = useState([]);
            const [activeDrag, setActiveDrag] = useState(null); 
            const [flowerProgress, setFlowerProgress] = useState(0);
            const [modalMessage, setModalMessage] = useState(null); // { title, text, type }
            const [focusTime, setFocusTime] = useState(25);
            const [breakTime, setBreakTime] = useState(5);
            const [isEditing, setIsEditing] = useState(false);

            // Expanded Decorations List
            const DECORATION_ITEMS = [
                '‚òï', 'üïØÔ∏è', 'ü™¥', 'üìö', 'üß∏', 'üéß', 'üß∂', 'üåµ', 'üîÆ', 'üñºÔ∏è', 'üêà‚Äç‚¨õ', 'üçë', 'üåô', '‚ú®',
                'üßÅ', 'üçì', 'üéÄ', 'üéπ', 'üéª', 'üé∑', 'üé®', 'üöÄ', 'üõ∏', 'ü™ê', 'üè∞', 'üé°', 'üß∏', 'ü•ê', 'ü•û',
                'üíê', 'üç´', 'üç©', 'üç™', 'üç¨', 'üç≠', 'üçÆ', 'üçØ', 'üçº', 'ü•õ', 'üßÉ', 'üßâ', 'üßä'
            ];

            // Load saved decorations on mount
            useEffect(() => {
                const saved = localStorage.getItem('cat_decorations');
                if (saved) setDecorations(JSON.parse(saved));
            }, []);

            // Save decorations on change
            useEffect(() => {
                localStorage.setItem('cat_decorations', JSON.stringify(decorations));
            }, [decorations]);

            useEffect(() => {
                let interval = null;
                if (isActive && timeLeft > 0) {
                    interval = setInterval(() => {
                        setTimeLeft(t => t - 1);
                        if (mode === 'focus') {
                             // Calculate progress: (Total - Current) / Total * 100
                             const total = focusTime * 60;
                             setFlowerProgress(((total - (timeLeft - 1)) / total) * 100);
                        }
                    }, 1000);
                } else if (timeLeft === 0 && isActive) {
                    setIsActive(false);
                    if (mode === 'focus') {
                        // Focus Session Done
                        setCycle(c => c + 1);
                        unlockReward();
                        // Add completed lily to decorations
                         const lilyDeco = {
                            id: Date.now() + 1, // Ensure unique ID from reward
                            type: 'lily',
                            content: 'lily', // Placeholder for type check
                            x: 50 + (Math.random() * 20 - 10), // Spawn near center
                            y: 50 + (Math.random() * 20 - 10)
                        };
                        setDecorations(prev => [...prev, lilyDeco]);
                        
                        setModalMessage({
                            title: "Good job, kitten!",
                            text: "You did amazing! üñ§ Here is a treat for you. Take a well-deserved break.",
                            button: "Start Break",
                            nextMode: "break"
                        });
                        setFlowerProgress(100); 
                    } else {
                        // Break Done
                        setModalMessage({
                            title: "Break's Over!",
                            text: "Ready to conquer the world again? Keep going! üí™",
                            button: "Start Focus",
                            nextMode: "focus"
                        });
                        setFlowerProgress(0);
                    }
                }
                return () => clearInterval(interval);
            }, [isActive, timeLeft, mode, focusTime]); // Added focusTime dependency

            const toggleTimer = () => setIsActive(!isActive);
            
            const resetTimer = () => {
                setIsActive(false);
                setTimeLeft(mode === 'focus' ? focusTime * 60 : breakTime * 60);
                if (mode === 'focus') setFlowerProgress(0);
            };

            const switchMode = (newMode) => {
                setMode(newMode);
                setIsActive(false);
                setTimeLeft(newMode === 'focus' ? focusTime * 60 : breakTime * 60);
                if (newMode === 'focus') setFlowerProgress(0);
            };

            const updateTimes = (newFocus, newBreak) => {
                const f = parseInt(newFocus) || 25;
                const b = parseInt(newBreak) || 5;
                setFocusTime(f);
                setBreakTime(b);
                if (!isActive) {
                     setTimeLeft(mode === 'focus' ? f * 60 : b * 60);
                }
            };
            
            const quickSet = (f, b) => {
                updateTimes(f, b);
                // Optional: Auto reset if not active
                 if (!isActive) {
                     setTimeLeft(mode === 'focus' ? f * 60 : b * 60);
                }
            }

            const unlockReward = () => {
                const item = DECORATION_ITEMS[Math.floor(Math.random() * DECORATION_ITEMS.length)];
                const newDeco = {
                    id: Date.now(),
                    content: item,
                    x: 20 + Math.random() * 60, 
                    y: 20 + Math.random() * 60
                };
                setDecorations(prev => [...prev, newDeco]);
            };

            const handlePointerDown = (e, id) => {
                e.preventDefault(); 
                setActiveDrag({ id });
            };
            
            const containerRef = useRef(null);

            const onContainerMove = (e) => {
                if (!activeDrag || !containerRef.current) return;
                e.preventDefault(); 
                
                const rect = containerRef.current.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                const xPct = ((clientX - rect.left) / rect.width) * 100;
                const yPct = ((clientY - rect.top) / rect.height) * 100;

                setDecorations(prev => prev.map(d => 
                    d.id === activeDrag.id 
                    ? { ...d, x: Math.min(95, Math.max(5, xPct)), y: Math.min(95, Math.max(5, yPct)) } 
                    : d
                ));
            };

            const onContainerUp = () => {
                setActiveDrag(null);
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            };

            const handleModalClose = () => {
                if (modalMessage.nextMode) {
                    switchMode(modalMessage.nextMode);
                }
                setModalMessage(null);
            }

            return (
                <div 
                    className="h-full flex flex-col bg-slate-900 overflow-hidden relative"
                    onMouseMove={onContainerMove}
                    onTouchMove={onContainerMove}
                    onMouseUp={onContainerUp}
                    onTouchEnd={onContainerUp}
                    ref={containerRef}
                >
                    {/* Modal Overlay */}
                    {modalMessage && (
                        <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-slate-800 border-2 border-pink-500 rounded-xl p-6 max-w-sm text-center shadow-2xl m-4">
                                <h3 className="text-2xl font-bold text-pink-400 mb-2">{modalMessage.title}</h3>
                                <p className="text-slate-300 mb-6">{modalMessage.text}</p>
                                <button 
                                    onClick={handleModalClose}
                                    className="px-6 py-3 bg-pink-600 hover:bg-pink-500 text-white rounded-full font-bold transition-all transform hover:scale-105"
                                >
                                    {modalMessage.button}
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Header */}
                    <div className="p-2 text-center z-10 flex flex-col items-center w-full">
                        <div className="flex justify-between items-center w-full px-4 mb-2">
                             <h2 className="text-2xl font-bold text-pink-300">Focus Room</h2>
                             <button 
                                onClick={() => setIsEditing(!isEditing)} 
                                className="text-slate-400 hover:text-white transition-colors"
                             >
                                <Settings size={20} />
                             </button>
                        </div>
                        
                        {/* Settings Panel */}
                        {isEditing && (
                            <div className="bg-slate-800/90 p-4 rounded-xl mb-4 border border-slate-700 w-full max-w-xs animate-in slide-in-from-top-2">
                                <div className="flex gap-2 mb-4 justify-center">
                                    <div className="flex flex-col">
                                        <label className="text-xs text-slate-400 mb-1">Focus (min)</label>
                                        <input 
                                            type="number" 
                                            value={focusTime} 
                                            onChange={(e) => updateTimes(e.target.value, breakTime)}
                                            className="bg-slate-900 border border-slate-600 rounded p-2 w-20 text-center text-white"
                                        />
                                    </div>
                                    <div className="flex flex-col">
                                        <label className="text-xs text-slate-400 mb-1">Break (min)</label>
                                        <input 
                                            type="number" 
                                            value={breakTime} 
                                            onChange={(e) => updateTimes(focusTime, e.target.value)}
                                            className="bg-slate-900 border border-slate-600 rounded p-2 w-20 text-center text-white"
                                        />
                                    </div>
                                </div>
                                <div className="flex gap-2 justify-center text-xs">
                                    <button onClick={() => quickSet(25, 5)} className="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded">25/5</button>
                                    <button onClick={() => quickSet(50, 10)} className="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded">50/10</button>
                                    <button onClick={() => quickSet(60, 15)} className="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded">60/15</button>
                                </div>
                            </div>
                        )}
                        
                        <div className="flex justify-center gap-2 mb-4">
                            <button onClick={() => switchMode('focus')} className={`px-4 py-1 rounded-full text-sm font-bold transition-colors ${mode === 'focus' ? 'bg-pink-600 text-white' : 'bg-slate-800 text-slate-400'}`}>Focus</button>
                            <button onClick={() => switchMode('break')} className={`px-4 py-1 rounded-full text-sm font-bold transition-colors ${mode === 'break' ? 'bg-green-600 text-white' : 'bg-slate-800 text-slate-400'}`}>Break</button>
                        </div>

                        {/* Flower Visualization - Only shows in Focus mode or if grown */}
                        {mode === 'focus' && !isEditing && <StargazerLily progress={flowerProgress} />}
                        
                        {/* Timer Display */}
                        <div className="text-5xl font-mono font-bold text-white mb-4 tracking-wider drop-shadow-lg">
                            {formatTime(timeLeft)}
                        </div>

                        <div className="flex justify-center gap-4">
                            <button onClick={toggleTimer} className="w-14 h-14 bg-white text-black rounded-full flex items-center justify-center hover:bg-pink-100 transition-colors shadow-lg">
                                {isActive ? <Pause /> : <Play />}
                            </button>
                            <button onClick={resetTimer} className="w-14 h-14 bg-slate-800 text-slate-300 rounded-full flex items-center justify-center hover:bg-slate-700 transition-colors shadow-lg">
                                <RefreshCw />
                            </button>
                        </div>
                        
                        <div className="mt-2 text-xs text-slate-500">
                            Sessions Completed: {cycle}
                        </div>
                    </div>

                    {/* Room / Decoration Area */}
                    <div className="flex-1 relative bg-slate-800/50 m-4 rounded-xl border-2 border-slate-700 shadow-inner overflow-hidden">
                        <div className="absolute inset-0 pointer-events-none opacity-10 flex items-center justify-center text-8xl">
                             üìö
                        </div>
                        <div className="absolute bottom-2 left-0 right-0 text-center text-xs text-slate-500 pointer-events-none">
                            Drag items to decorate your space
                        </div>

                        {/* Render Decorations */}
                        {decorations.map(deco => (
                            <div
                                key={deco.id}
                                className="absolute text-3xl cursor-grab active:cursor-grabbing hover:scale-125 transition-transform select-none"
                                style={{ left: `${deco.x}%`, top: `${deco.y}%`, transform: 'translate(-50%, -50%)' }}
                                onMouseDown={(e) => handlePointerDown(e, deco.id)}
                                onTouchStart={(e) => handlePointerDown(e, deco.id)}
                            >
                                {deco.type === 'lily' ? (
                                    <div style={{ width: '60px', height: '60px' }}>
                                        <StargazerLily progress={100} />
                                    </div>
                                ) : (
                                    deco.content
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const App = () => {
             // ... (Restored App Component) ...
            const [view, setView] = useState('home'); 
            const [score, setScore] = useState(0);
            const NavButton = ({ target, icon: Icon, label }) => ( <button onClick={() => setView(target)} className={`flex flex-col items-center gap-1 p-2 ${view === target ? 'text-pink-400' : 'text-slate-500 hover:text-slate-300'}`}> <Icon size={24} /> <span className="text-xs">{label}</span> </button> );
            return ( <div className="bg-slate-950 min-h-screen text-slate-200 font-sans selection:bg-pink-500 selection:text-white relative overflow-hidden"> <StarBackground /> <main className="relative z-10 h-[calc(100vh-80px)] overflow-y-auto pb-20 scrollbar-hide"> {view === 'home' && ( <div className="flex flex-col items-center justify-center min-h-full p-8 text-center"> <div className="mb-6 relative"> <div className="absolute inset-0 bg-pink-500 blur-3xl opacity-20 rounded-full"></div> <Cat size={80} className="text-slate-100 relative z-10" /> </div> <h1 className="text-4xl md:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-300 via-purple-300 to-indigo-300 mb-4 tracking-tight"> The Black Cat's (you)<br/>Midnight Picnic </h1> <p className="text-slate-400 max-w-md mb-8"> A collection of mini-stuff for you &lt;3. </p> <button onClick={() => setView('game')} className="px-8 py-3 bg-white text-black font-bold rounded-full hover:bg-pink-200 transition-colors flex items-center gap-2" > <Play size={16} fill="black" /> Enter World </button> </div> )} {view === 'game' && <PicnicGame />} {view === 'rpg' && <RPGGame />} {view === 'study' && <Pomodoro />} {view === 'facts' && <ConstellationGallery />} {view === 'letter' && <LoveLetter />} </main> <nav className="fixed bottom-0 left-0 w-full bg-slate-900/90 backdrop-blur-md border-t border-slate-800 z-50 h-20 pb-2"> <div className="flex justify-around items-center h-full max-w-md mx-auto"> <NavButton target="home" icon={Tent} label="Camp" /> <NavButton target="rpg" icon={MapIcon} label="Adv" /> <NavButton target="study" icon={Book} label="Study" /> <NavButton target="game" icon={Coffee} label="Picnic" /> <NavButton target="facts" icon={Star} label="Stars" /> <NavButton target="letter" icon={Heart} label="Msg" /> </div> </nav> </div> );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>