<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>The Black Cat's Midnight Picnic</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebaseModules = { 
            initializeApp, 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            onSnapshot, 
            collection 
        };
    </script>
    
    <style>
        /* --- GLOBAL STYLES --- */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        body {
            background-color: #020617; /* Slate 950 */
            color: #e2e8f0; /* Slate 200 */
            overscroll-behavior: none; /* Prevent pull-to-refresh on mobile */
            margin: 0;
            padding: 0;
            height: 100vh; /* Fallback */
            height: 100dvh;
        }
        #root {
            height: 100%;
        }
        /* Mobile safe area padding for notches/home bars */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }
        /* Dynamic Height Classes */
        .h-dvh {
            height: 100vh;
            height: 100dvh;
        }
        .content-height {
            height: calc(100vh - 80px);
            height: calc(100dvh - 80px);
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }
        .star {
            animation: twinkle 3s infinite ease-in-out;
        }
        .pixel-art {
            image-rendering: pixelated;
        }
        @keyframes bloom {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes float-away {
            0% { transform: scale(1) translateY(0); opacity: 1; }
            100% { transform: scale(0.01) translateY(-400px); opacity: 0; }
        }
        @keyframes fade-in-out {
            0% { opacity: 0; transform: translateY(10px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
        .animate-message {
            animation: fade-in-out 8s ease-in-out forwards;
        }
        @keyframes ascend-bright {
            0% { transform: scale(1) translateY(0); opacity: 1; filter: drop-shadow(0 0 10px white); }
            100% { transform: scale(0.8) translateY(-200px); opacity: 0.9; filter: drop-shadow(0 0 50px gold); }
        }
        /* Boss Pulse Animation */
        @keyframes boss-pulse {
            0% { transform: scale(1); filter: drop-shadow(0 0 5px red); }
            50% { transform: scale(1.1); filter: drop-shadow(0 0 15px red); }
            100% { transform: scale(1); filter: drop-shadow(0 0 5px red); }
        }
        .boss-anim {
            animation: boss-pulse 2s infinite ease-in-out;
        }
        /* Float Up Animation for Reactions */
        @keyframes float-up {
            0% { transform: translateY(0) scale(1) rotate(0deg); opacity: 1; }
            50% { opacity: 0.8; }
            100% { transform: translateY(-300px) scale(1.5) rotate(20deg); opacity: 0; }
        }
        .animate-float-up {
            animation: float-up 2s ease-out forwards;
            position: absolute;
            pointer-events: none;
            z-index: 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- FIREBASE INIT WRAPPER ---
        // We use a mutable object to hold instances so components can access them even if loaded async
        const fb = { 
            auth: null, 
            db: null, 
            appId: 'default-app-id', 
            initialized: false 
        };

        // --- ICONS ---
        const IconBase = ({ children, size = 24, className = "", fill = "none" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );

        const Heart = (props) => <IconBase {...props}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" /></IconBase>;
        const Music = (props) => <IconBase {...props}><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></IconBase>;
        const Star = (props) => <IconBase {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconBase>;
        const Tent = (props) => <IconBase {...props}><path d="M3.5 21 14 3"/><path d="M20.5 21 10 3"/><path d="M15.5 21 12 15l-3.5 6"/><path d="M2 21h20"/></IconBase>;
        const Cat = ({ size = 24, className = "" }) => <div className={`flex items-center justify-center ${className}`} style={{ width: size, height: size, fontSize: size * 0.8, lineHeight: 1 }}>üêà‚Äç‚¨õ</div>;
        const Coffee = (props) => <IconBase {...props}><path d="M10 2v2"/><path d="M14 2v2"/><path d="M16 8a1 1 0 0 1 1 1v8a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V9a1 1 0 0 1 1-1h14a4 4 0 1 1 0 8h-1"/><path d="M6 2v2"/></IconBase>;
        const X = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const Play = (props) => <IconBase {...props}><polygon points="5 3 19 12 5 21 5 3"/></IconBase>;
        const Pause = (props) => <IconBase {...props}><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></IconBase>;
        const Zap = (props) => <IconBase {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>;
        const Timer = (props) => <IconBase {...props}><line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/><circle cx="12" cy="14" r="8"/></IconBase>;
        const Trophy = (props) => <IconBase {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconBase>;
        const RefreshCw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>;
        const MapIcon = (props) => <IconBase {...props}><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></IconBase>;
        const Book = (props) => <IconBase {...props}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></IconBase>;
        const Settings = (props) => <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const Sword = (props) => <IconBase {...props}><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" x2="19" y1="19" y2="13"/><line x1="16" x2="20" y1="16" y2="20"/><line x1="19" x2="21" y1="21" y2="19"/></IconBase>;
        const Cloud = (props) => <IconBase {...props}><path d="M17.5 19c0-1.7-1.3-3-3-3h-11c-1.7 0-3 1.3-3 3s1.3 3 3 3h11c1.7 0 3-1.3 3-3z"/><path d="M17.5 16c2.5 0 4.5-2 4.5-4.5S19.5 7 17.5 7c-.5 0-1 .1-1.4.3-.9-2.6-3.4-4.3-6.1-4.3-3.6 0-6.5 2.9-6.5 6.5 0 .4 0 .9.1 1.3C1.6 11.6 0 13.6 0 16c0 2.5 2 4.5 4.5 4.5h13c2.5 0 4.5-2 4.5-4.5z"/></IconBase>;
        const Volume2 = (props) => <IconBase {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07" /></IconBase>;
        const VolumeX = (props) => <IconBase {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><line x1="23" y1="9" x2="17" y2="15" /><line x1="17" y1="9" x2="23" y2="15" /></IconBase>;
        const Feather = (props) => <IconBase {...props}><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"/><line x1="16" y1="8" x2="2" y2="22"/><line x1="17.5" y1="15" x2="9" y2="15"/></IconBase>;
        const Globe = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1 4-10z"/></IconBase>;
        const Gamepad = (props) => <IconBase {...props}><line x1="6" y1="12" x2="10" y2="12" /><line x1="8" y1="10" x2="8" y2="14" /><line x1="15" y1="13" x2="15.01" y2="13" /><line x1="18" y1="11" x2="18.01" y2="11" /><rect x="2" y="6" width="20" height="12" rx="2" /></IconBase>;
        const Scissors = (props) => <IconBase {...props}><circle cx="6" cy="6" r="3" /><circle cx="6" cy="18" r="3" /><line x1="20" y1="4" x2="8.12" y2="15.88" /><line x1="14.47" y1="14.48" x2="20" y2="20" /><line x1="8.12" y1="8.12" x2="12" y2="12" /></IconBase>;

        // --- ASSETS & CONFIG ---
        const GAME_ITEMS = [
            { type: 'good', emoji: 'üçî', value: 10, label: 'Burger' },
            { type: 'good', emoji: 'üçó', value: 10, label: 'Chicken Leg' },
            { type: 'good', emoji: 'ü™º', value: 10, label: 'Jellyfish' },
            { type: 'bonus', emoji: 'üßã', value: 50, label: 'Bubble Tea' },
            { type: 'good', emoji: 'üç™', value: 5, label: 'Soft Cookie' },
            { type: 'good', emoji: 'üëÖ', value: 10, label: 'Tongue' },
            { type: 'good', emoji: 'üßé', value: 10, label: 'Kneeling' },
            { type: 'good', emoji: 'üçë', value: 10, label: 'Nectarine' },
            { type: 'good', emoji: 'üçÜ', value: 10, label: 'Eggplant' },
            { type: 'good', emoji: 'üßÑ', value: 10, label: 'Garlic' },
            { type: 'good', emoji: '‚õ∫', value: 10, label: 'Tent' },
            { type: 'bad', emoji: 'ü•Ä', value: -10, label: 'Wilted Flower' },
            { type: 'bad', emoji: 'ü¶ë', value: -15, label: 'Calamari' },
            { type: 'bad', emoji: '‚õàÔ∏è', value: -20, label: 'Bad Weather' },
            { type: 'bad', emoji: 'ü¶†', value: -15, label: 'Germ' },
            { type: 'bad', emoji: '‚ôÇÔ∏è', value: -20, label: 'Men' },
        ];

        const LEVEL_CONFIG = [
            { level: 1, target: 50, time: 30, speed: 4, spawnRate: 0.03, title: "Warm Up" },
            { level: 2, target: 100, time: 30, speed: 5, spawnRate: 0.04, title: "Getting Hungry" },
            { level: 3, target: 150, time: 35, speed: 6, spawnRate: 0.05, title: "Midnight Snack" },
            { level: 4, target: 200, time: 40, speed: 7, spawnRate: 0.06, title: "Fast Food" },
            { level: 5, target: 250, time: 45, speed: 8, spawnRate: 0.08, title: "The Fiercest Hunt" },
        ];

        const DECORATION_ITEMS = [
            '‚òï', 'üïØÔ∏è', 'ü™¥', 'üìö', 'üß∏', 'üéß', 'üß∂', 'üåµ', 'üîÆ', 'üñºÔ∏è', 'üêà‚Äç‚¨õ', 'üçë', 'üåô', '‚ú®',
            'üßÅ', 'üçì', 'üéÄ', 'üéπ', 'üéª', 'üé∑', 'üé®', 'üöÄ', 'üõ∏', 'ü™ê', 'üè∞', 'üé°', 'üß∏', 'ü•ê', 'ü•û',
            'üíê', 'üç´', 'üç©', 'üç™', 'üç¨', 'üç≠', 'üçÆ', 'üçØ', 'üçº', 'ü•õ', 'üßÉ', 'üßâ', 'üßä'
        ];
        
        const MUSIC_POOL = [
            // Greek Pulp-Pop / Alternative
            "42wkMrkIqX4pYIGnTW70kG", // To Sima
            "6ucNZBkwkPmw8OHiv5L7P4", // Pygolampides
            "7Gi8jg3h2Ac0gMetpQUXmh", // To Koperti
            "70LpDqsreV4MtlQzyyV87G", // San Ihthis
            "5Od7Y3ihqhynfNBL10GS1V", // To Forema
            "3rBCyn5i76CRYE5theSiB5", // Den Ksero
            "7jhyoVX7uqGLLnoEvSSSnY", // O Erotas
            "1cQ4zuzVnux91bI1tJR1G7", // Mehri Ta Haramata
            "1tpcE1Ujav8q4fJgJMW4kb", // Fotia Sto Limani
            "00hbwu3tPnbiH5MNjzF14N", // Oso Mikraino
            
            // Bedroom Pop
            "0H2zA6m04MUsu4mX2KecNr", // Fall Down (Crumb)
            "6XHikJpK06NoXaFwkH4tPL", // I Spend Too Much Time in My Room
            "2HcMkGeghyXdJRT1g85u0t", // To Ease You (Men I Trust)
            "6R2YSITVeRTFwDczaxSnQS", // Hard To See
            
            // Indie Surf / Dream Pop
            "4zGub7d71FopcEXaLKqxcU", // Tom's Place
            "1ixXNc8iCkRniJhICf9xpy", // Turning Over a New Leaf
            "4l38jp3bDPcI5avo9ov482", // Seabird
            "3WSaGTmm67vd3stVi0Zu9D"  // Undercurrent
        ];
        
        // --- POEM DATABASE (50+ Poems) ---
        const POEMS = [
            { title: "Hope is the thing with feathers", author: "Emily Dickinson", lines: ["Hope is the thing with feathers", "That perches in the soul,", "And sings the tune without the words,", "And never stops at all,", "", "And sweetest in the Gale is heard;", "And sore must be the storm", "That could abash the little Bird", "That kept so many warm.", "", "I‚Äôve heard it in the chillest land,", "And on the strangest Sea;", "Yet, never, in Extremity,", "It asked a crumb of me."] },
            { title: "A Dream Within a Dream", author: "Edgar Allan Poe", lines: ["Take this kiss upon the brow!", "And, in parting from you now,", "Thus much let me avow ‚Äî", "You are not wrong, who deem", "That my days have been a dream;", "Yet if hope has flown away", "In a night, or in a day,", "In a vision, or in none,", "Is it therefore the less gone?", "All that we see or seem", "Is but a dream within a dream."] },
            { title: "She Walks in Beauty", author: "Lord Byron", lines: ["She walks in beauty, like the night", "Of cloudless climes and starry skies;", "And all that‚Äôs best of dark and bright", "Meet in her aspect and her eyes;", "Thus mellowed to that tender light", "Which heaven to gaudy day denies."] },
            { title: "Wild Nights ‚Äì Wild Nights!", author: "Emily Dickinson", lines: ["Wild Nights ‚Äì Wild Nights!", "Were I with thee", "Wild Nights should be", "Our luxury!", "", "Futile ‚Äì the Winds ‚Äì", "To a Heart in port ‚Äì", "Done with the Compass ‚Äì", "Done with the Chart!", "", "Rowing in Eden ‚Äì", "Ah, the Sea!", "Might I but moor ‚Äì Tonight ‚Äì", "In Thee!"] },
            { title: "Variations on the Word Sleep", author: "Margaret Atwood", lines: ["I would like to watch you sleeping,", "which may not happen.", "I would like to watch you,", "sleeping. I would like to sleep", "with you, to enter", "your sleep as its smooth dark wave", "slides over my head."] }
        ];

        // --- COMPONENTS ---

        const StarBackground = () => {
            const [stars, setStars] = useState([]);
            useEffect(() => {
                const s = [];
                for(let i=0; i<50; i++) {
                    s.push({
                        top: Math.random() * 100,
                        left: Math.random() * 100,
                        size: Math.random() * 3,
                        delay: Math.random() * 2,
                        duration: Math.random() * 3 + 2
                    });
                }
                setStars(s);
            }, []);

            return (
                <div className="fixed inset-0 overflow-hidden pointer-events-none z-0">
                    {stars.map((s, i) => (
                        <div key={i} className="absolute bg-white rounded-full opacity-70 star" style={{ top: `${s.top}%`, left: `${s.left}%`, width: `${s.size}px`, height: `${s.size}px`, animationDuration: `${s.duration}s`, animationDelay: `${s.delay}s` }} />
                    ))}
                </div>
            );
        };

        // --- LILY COMPONENT (Blooms based on progress) ---
        const StargazerLily = ({ progress }) => { 
            // progress: 0 (start) -> 1 (complete)
            // scale: 0.1 -> 1.0
            const scale = 0.1 + (progress * 0.9);
            const opacity = 0.4 + (progress * 0.6);
            // Petal opening: closed (scaleY 0.2) to open (scaleY 1)
            const bloom = 0.2 + (progress * 0.8);

            return (
                <div className="relative w-64 h-64 flex items-center justify-center transition-all duration-1000 ease-out" style={{ transform: `scale(${scale})`, opacity: opacity }}>
                    <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-[0_0_25px_rgba(236,72,153,0.6)]">
                        {/* Stem */}
                        <path d="M50 100 Q50 80 50 60" stroke="#064e3b" strokeWidth="2" fill="none" />
                        
                        {/* Petals Group - Rotates/Blooms */}
                        <g transform="translate(50,50)">
                            {[0, 60, 120, 180, 240, 300].map((angle, i) => (
                                <g key={i} transform={`rotate(${angle}) scale(1, ${bloom})`}>
                                    <path d="M0 0 Q-10 -40 0 -50 Q10 -40 0 0" fill="#ec4899" stroke="#be185d" strokeWidth="0.5" />
                                    <path d="M0 -10 L0 -40" stroke="#be185d" strokeWidth="0.2" />
                                    <circle cx="0" cy="-35" r="1" fill="#facc15" />
                                </g>
                            ))}
                        </g>
                        
                        {/* Center */}
                        <circle cx="50" cy="50" r={3 * progress} fill="#facc15" stroke="#a16207" strokeWidth="0.5" />
                    </svg>
                </div>
            ) 
        };

        // --- POMODORO / STUDY ROOM ---
        const Pomodoro = () => {
            const [timeLeft, setTimeLeft] = useState(25 * 60);
            const [isActive, setIsActive] = useState(false);
            const [mode, setMode] = useState('focus');
            const [isEditing, setIsEditing] = useState(false);
            const [focusTime, setFocusTime] = useState(25);
            const [breakTime, setBreakTime] = useState(5);
            
            // New: Reactions State
            const [floatingEmojis, setFloatingEmojis] = useState([]);
            // New: Progress for Lily
            const [progress, setProgress] = useState(0);

            const containerRef = useRef(null);

            // Updated emoji list for Study Room: Teddy, Cat, Nectarine, Moon, Chicken Leg
            const STUDY_REACTIONS = ['üß∏', 'üêà‚Äç‚¨õ', 'üçë', 'üåô', 'üßÅ', 'üçó'];

            // Timer Logic
            useEffect(() => {
                let interval = null;
                if (isActive && timeLeft > 0) {
                    interval = setInterval(() => {
                        setTimeLeft(t => {
                            const newTime = t - 1;
                            // Calculate progress for lily
                            const totalSeconds = (mode === 'focus' ? focusTime : breakTime) * 60;
                            const elapsed = totalSeconds - newTime;
                            setProgress(Math.min(elapsed / totalSeconds, 1));
                            return newTime;
                        });
                    }, 1000);
                } else if (timeLeft === 0 && isActive) {
                    setIsActive(false);
                    setProgress(1); // Fully bloom at end
                }
                return () => clearInterval(interval);
            }, [isActive, timeLeft, mode, focusTime, breakTime]);

            // Handlers
            const toggleTimer = () => setIsActive(!isActive);
            const resetTimer = () => { 
                setIsActive(false); 
                const newTime = mode === 'focus' ? focusTime * 60 : breakTime * 60;
                setTimeLeft(newTime);
                setProgress(0); // Reset lily
            };
            const switchMode = (newMode) => { 
                setMode(newMode); 
                setIsActive(false); 
                const newTime = newMode === 'focus' ? focusTime * 60 : breakTime * 60;
                setTimeLeft(newTime);
                setProgress(0); 
            };
            
            const updateTimes = (newFocus, newBreak) => { 
                const f = parseInt(newFocus) || 25; const b = parseInt(newBreak) || 5; 
                setFocusTime(f); setBreakTime(b); 
                if (!isActive) {
                    const newTime = mode === 'focus' ? f * 60 : b * 60;
                    setTimeLeft(newTime);
                }
            };
            
            const formatTime = (s) => { 
                const m = Math.floor(s/60); 
                const sc = s%60; 
                return `${m}:${sc < 10 ? '0' : ''}${sc}`; 
            };

            // Reaction Logic (Instagram style flow up)
            const handleReaction = (emoji) => {
                const id = Date.now() + Math.random();
                // Randomize start X slightly
                const randomX = Math.random() * 20 - 10; // -10 to +10 px offset
                const newReaction = { id, emoji, offset: randomX };
                
                setFloatingEmojis(prev => [...prev, newReaction]);
                
                // Cleanup after animation
                setTimeout(() => {
                    setFloatingEmojis(prev => prev.filter(e => e.id !== id));
                }, 2000);
            };

            return (
                <div className="h-full flex flex-col bg-slate-900 overflow-hidden relative" ref={containerRef}>
                    {/* Content Area */}
                    <div className="flex-1 flex flex-col items-center justify-center relative p-4">
                        
                        {/* Top Controls */}
                        <div className="absolute top-4 w-full px-4 flex justify-between items-center z-20">
                             <h2 className="text-2xl font-bold text-pink-300">Focus Room</h2>
                             <button onClick={() => setIsEditing(!isEditing)} className="text-slate-400 hover:text-white"><Settings size={20} /></button>
                        </div>

                        {/* Settings Panel */}
                        {isEditing && (
                            <div className="absolute top-16 bg-slate-800/90 p-4 rounded-xl border border-slate-700 z-30 animate-in fade-in">
                                <div className="flex gap-4 text-xs mb-2">
                                    <div className="flex flex-col"><label className="text-slate-400 mb-1">Focus</label><input type="number" value={focusTime} onChange={e => updateTimes(e.target.value, breakTime)} className="w-12 bg-slate-900 text-center rounded p-1 text-white"/></div>
                                    <div className="flex flex-col"><label className="text-slate-400 mb-1">Break</label><input type="number" value={breakTime} onChange={e => updateTimes(focusTime, e.target.value)} className="w-12 bg-slate-900 text-center rounded p-1 text-white"/></div>
                                </div>
                            </div>
                        )}

                        {/* The Lily (Blooms with progress) */}
                        <div className="mb-4 relative z-10">
                             <StargazerLily progress={progress} />
                        </div>
                        
                        {/* Timer Display */}
                        <div className="text-6xl font-mono font-bold text-white mb-8 tracking-wider drop-shadow-[0_0_15px_rgba(255,255,255,0.3)] relative z-10">
                            {formatTime(timeLeft)}
                        </div>

                        {/* Main Controls */}
                        <div className="flex gap-6 relative z-10">
                            <button onClick={toggleTimer} className="w-16 h-16 bg-white text-black rounded-full flex items-center justify-center hover:bg-pink-100 shadow-[0_0_20px_rgba(255,255,255,0.4)] transition-transform hover:scale-105">
                                {isActive ? <Pause size={24}/> : <Play size={24} className="ml-1"/>}
                            </button>
                            <button onClick={resetTimer} className="w-16 h-16 bg-slate-800 text-slate-300 border border-slate-700 rounded-full flex items-center justify-center hover:bg-slate-700 hover:text-white shadow-lg transition-transform hover:scale-105">
                                <RefreshCw size={20}/>
                            </button>
                        </div>

                        {/* Mode Switcher */}
                        <div className="flex gap-2 mt-8 bg-slate-800/50 p-1 rounded-full border border-slate-700 relative z-10">
                            <button onClick={() => switchMode('focus')} className={`px-4 py-1 rounded-full text-xs font-bold transition-colors ${mode === 'focus' ? 'bg-pink-600 text-white' : 'text-slate-400'}`}>Focus</button>
                            <button onClick={() => switchMode('break')} className={`px-4 py-1 rounded-full text-xs font-bold transition-colors ${mode === 'break' ? 'bg-green-600 text-white' : 'text-slate-400'}`}>Break</button>
                        </div>
                    </div>

                    {/* Floating Emojis Container */}
                    <div className="absolute inset-0 pointer-events-none overflow-hidden z-0">
                         {floatingEmojis.map(reaction => (
                             <div 
                                key={reaction.id}
                                className="animate-float-up text-4xl absolute bottom-20"
                                style={{ 
                                    left: `calc(50% + ${reaction.offset}px)`,
                                    marginLeft: '-1rem' // Center roughly
                                }}
                             >
                                 {reaction.emoji}
                             </div>
                         ))}
                    </div>

                    {/* Bottom Reaction Bar */}
                    <div className="h-20 bg-slate-900/80 backdrop-blur-md border-t border-slate-800 flex items-center justify-center gap-4 px-4 pb-4 z-20">
                         {STUDY_REACTIONS.map((emoji, i) => (
                             <button 
                                key={i}
                                onClick={() => handleReaction(emoji)}
                                className="text-2xl hover:scale-125 active:scale-90 transition-transform p-2"
                             >
                                 {emoji}
                             </button>
                         ))}
                    </div>
                </div>
            );
        };

        const PicnicGame = ({ onGameOver }) => {
            const [gameState, setGameState] = useState('start');
            const [currentLevelIdx, setCurrentLevelIdx] = useState(0);
            const [score, setScore] = useState(0);
            const [timeLeft, setTimeLeft] = useState(0);

            const itemsRef = useRef([]);
            const floatingTextsRef = useRef([]);
            const playerPosRef = useRef(50);
            const scoreRef = useRef(0);
            const playerDomRef = useRef(null);
            const requestRef = useRef();
            const lastTimeRef = useRef(0);
            
            const [items, setItems] = useState([]);
            const [floatingTexts, setFloatingTexts] = useState([]);
            const [playerPos, setPlayerPos] = useState(50); 
            const currentLevelConfig = LEVEL_CONFIG[currentLevelIdx];
            
            const resetLevel = () => {
                itemsRef.current = [];
                floatingTextsRef.current = [];
                scoreRef.current = 0;
                setScore(0);
                setItems([]);
                setFloatingTexts([]);
                setTimeLeft(currentLevelConfig.time);
                setGameState('playing');
                lastTimeRef.current = Date.now();
            };

            const spawnItem = (spawnRate) => {
                if (Math.random() > spawnRate) return;
                const randomItem = GAME_ITEMS[Math.floor(Math.random() * GAME_ITEMS.length)];
                const newItem = {
                    id: Date.now() + Math.random(),
                    x: Math.random() * (window.innerWidth - 50),
                    y: -60,
                    width: 40,
                    height: 40,
                    ...randomItem
                };
                itemsRef.current.push(newItem);
            };

            const handleInput = (clientX) => {
                const width = window.innerWidth;
                const pos = (clientX / width) * 100;
                const clampedPos = Math.min(Math.max(pos, 5), 95);
                playerPosRef.current = clampedPos;
                setPlayerPos(clampedPos);
            };

            useEffect(() => {
                if (gameState !== 'playing') return;

                const gameLoop = () => {
                    const now = Date.now();
                    const dt = now - lastTimeRef.current;
                    
                    if (dt >= 1000) {
                        setTimeLeft(prev => {
                            const newTime = prev - 1;
                            if (newTime <= 0) return 0;
                            return newTime;
                        });
                        lastTimeRef.current = now;
                    }

                    if (scoreRef.current >= currentLevelConfig.target) {
                        setGameState(currentLevelIdx === LEVEL_CONFIG.length - 1 ? 'victory' : 'level_complete');
                        cancelAnimationFrame(requestRef.current);
                        return;
                    }

                    const currentItems = itemsRef.current;
                    const currentFloatingTexts = floatingTextsRef.current;
                    const nextItems = [];
                    const nextFloatingTexts = [];
                    let scoreDelta = 0;

                    let playerRect = { x: 0, y: 0, width: 0, height: 0 };
                    if (playerDomRef.current) {
                        const rect = playerDomRef.current.getBoundingClientRect();
                        playerRect = {
                            x: rect.x + 10,
                            y: rect.y + 10,
                            width: rect.width - 20,
                            height: rect.height - 20
                        };
                    }

                    currentFloatingTexts.forEach(ft => {
                        ft.y -= 2;
                        ft.life -= 1;
                        if (ft.life > 0) nextFloatingTexts.push(ft);
                    });

                    currentItems.forEach(item => {
                        item.y += currentLevelConfig.speed;
                        const itemRect = { x: item.x, y: item.y, width: 30, height: 30 };
                        const isColliding = 
                            itemRect.x < playerRect.x + playerRect.width &&
                            itemRect.x + itemRect.width > playerRect.x &&
                            itemRect.y < playerRect.y + playerRect.height &&
                            itemRect.y + itemRect.height > playerRect.y;

                        if (isColliding) {
                            scoreDelta += item.value;
                            nextFloatingTexts.push({
                                id: Date.now() + Math.random(),
                                x: item.x,
                                y: item.y,
                                text: item.value > 0 ? `+${item.value}` : `${item.value}`,
                                color: item.value > 0 ? 'text-green-400' : 'text-red-400',
                                life: 40
                            });
                        } else if (item.y < window.innerHeight) {
                            nextItems.push(item);
                        }
                    });

                    itemsRef.current = nextItems;
                    floatingTextsRef.current = nextFloatingTexts;
                    
                    setItems([...nextItems]); 
                    setFloatingTexts([...nextFloatingTexts]);

                    if (scoreDelta !== 0) {
                        scoreRef.current += scoreDelta;
                        setScore(scoreRef.current);
                    }

                    spawnItem(currentLevelConfig.spawnRate);
                    requestRef.current = requestAnimationFrame(gameLoop);
                };

                lastTimeRef.current = Date.now();
                requestRef.current = requestAnimationFrame(gameLoop);
                return () => cancelAnimationFrame(requestRef.current);
            }, [gameState, currentLevelConfig]);

            useEffect(() => {
                if (gameState === 'playing' && timeLeft === 0) {
                    setGameState('failed');
                }
            }, [timeLeft, gameState]);

            const renderOverlay = () => {
                if (gameState === 'playing') return null;

                let title = "";
                let message = "";
                let buttonText = "";
                let onButtonClick = null;
                let extraContent = null;

                switch (gameState) {
                    case 'start':
                        title = "Midnight Picnic Challenge";
                        message = "Are you ready to feed the Black Kitten (you)?";
                        buttonText = "Start Level 1";
                        onButtonClick = resetLevel;
                        extraContent = (
                            <div className="mt-4 text-sm text-pink-300 bg-black/40 p-3 rounded">
                                <div>Level 1 Goal:</div>
                                <div className="font-bold text-white text-lg">{LEVEL_CONFIG[0].target} points in {LEVEL_CONFIG[0].time}s</div>
                            </div>
                        );
                        break;
                    case 'level_complete':
                        title = "Delicious!";
                        message = `Level ${currentLevelIdx + 1} Complete!`;
                        buttonText = `Start Level ${currentLevelIdx + 2}`;
                        onButtonClick = () => {
                            if (currentLevelIdx < LEVEL_CONFIG.length - 1) {
                                setCurrentLevelIdx(prev => prev + 1);
                                setTimeout(() => {
                                    const nextLvl = LEVEL_CONFIG[currentLevelIdx + 1];
                                    itemsRef.current = [];
                                    scoreRef.current = 0;
                                    setScore(0);
                                    setTimeLeft(nextLvl.time);
                                    setGameState('playing');
                                    lastTimeRef.current = Date.now();
                                }, 50);
                            }
                        };
                        break;
                    case 'failed':
                        title = "Oh no! Too Slow!";
                        message = `You didn't eat enough. The kitten is still hungry.`;
                        buttonText = "Try Level Again";
                        onButtonClick = resetLevel;
                        break;
                    case 'victory':
                        return (
                            <div className="absolute inset-0 flex items-center justify-center z-50 bg-black/90 backdrop-blur-md animate-in fade-in duration-1000">
                                <div className="max-w-md w-full p-8 border-4 border-pink-500 rounded-3xl bg-slate-900 text-center relative overflow-hidden">
                                    <div className="absolute top-0 left-0 w-full h-full bg-pink-500/10 animate-pulse"></div>
                                    <div className="w-24 h-24 mx-auto bg-gradient-to-br from-pink-400 to-purple-600 rounded-full flex items-center justify-center mb-6 shadow-[0_0_30px_rgba(236,72,153,0.8)]">
                                        <Cat size={48} className="text-white" />
                                    </div>
                                    <h2 className="text-4xl font-serif text-transparent bg-clip-text bg-gradient-to-r from-pink-300 via-purple-300 to-white mb-6 font-bold">
                                        Congratulations!
                                    </h2>
                                    <div className="bg-white/5 p-6 rounded-xl border border-pink-500/30 backdrop-blur-sm mb-8 transform hover:scale-105 transition-transform">
                                        <Heart className="w-8 h-8 text-red-500 mx-auto mb-4 animate-bounce" fill="currentColor" />
                                        <p className="text-xl text-pink-100 font-serif italic leading-relaxed">
                                            "You're the fiercest black cat."
                                        </p>
                                    </div>
                                    <button 
                                        onClick={() => { setCurrentLevelIdx(0); setGameState('start'); }}
                                        className="text-slate-400 hover:text-white text-sm underline"
                                    >
                                        Play Again
                                    </button>
                                </div>
                            </div>
                        );
                    default:
                        return null;
                }

                return (
                    <div className="absolute inset-0 flex items-center justify-center z-30 bg-black/80 backdrop-blur-sm animate-in zoom-in-95 duration-300">
                        <div className="text-center p-8 border-2 border-pink-500 rounded-2xl bg-slate-900 shadow-[0_0_20px_rgba(236,72,153,0.5)] max-w-sm w-full mx-4">
                            <h2 className="text-3xl font-bold text-pink-400 mb-2">{title}</h2>
                            <p className="text-slate-300 mb-6">{message}</p>
                            {extraContent}
                            <div className="flex justify-center gap-4 mb-6 text-2xl">
                                <span>üçë</span><span>üç™</span><span>üßã</span>
                            </div>
                            <button 
                                onClick={onButtonClick}
                                className="w-full px-8 py-3 bg-pink-600 hover:bg-pink-500 text-white rounded-full font-bold transition-all transform hover:scale-105 shadow-lg shadow-pink-500/30"
                            >
                                {buttonText}
                            </button>
                        </div>
                    </div>
                );
            };

            return (
                <div 
                    className="relative w-full h-full touch-none overflow-hidden cursor-none"
                    onTouchMove={(e) => handleInput(e.touches[0].clientX)}
                    onMouseMove={(e) => handleInput(e.clientX)}
                >
                    <div className="absolute top-4 left-4 right-4 z-20 flex justify-between items-start pointer-events-none">
                        <div className="flex flex-col gap-2">
                            <div className="text-yellow-300 font-mono text-sm font-bold bg-black/60 p-2 rounded border border-yellow-500/30 flex items-center gap-2 w-fit">
                                <Zap size={14} /> LEVEL {currentLevelIdx + 1}
                            </div>
                            <div className="text-pink-300 font-mono text-lg font-bold bg-black/60 p-2 rounded border border-pink-500/30 flex items-center gap-2 w-fit">
                                <Trophy size={16} /> 
                                <span>{score} / {currentLevelConfig.target}</span>
                            </div>
                        </div>
                        <div className={`font-mono text-2xl font-bold bg-black/60 p-3 rounded-xl border flex items-center gap-2 ${timeLeft < 10 ? 'text-red-500 border-red-500 animate-pulse' : 'text-white border-slate-500'}`}>
                            <Timer size={24} /> {timeLeft}s
                        </div>
                    </div>

                    {renderOverlay()}

                    {items.map(item => (
                        <div 
                            key={item.id}
                            className="absolute text-4xl pointer-events-none"
                            style={{ left: item.x, top: item.y }}
                        >
                            {item.emoji}
                        </div>
                    ))}

                    {floatingTexts.map(ft => (
                        <div 
                            key={ft.id}
                            className={`absolute text-2xl font-black pointer-events-none ${ft.color} drop-shadow-md`}
                            style={{ 
                                left: ft.x, 
                                top: ft.y,
                                opacity: ft.life / 40,
                                transform: `translateY(-${(40 - ft.life)}px)`
                            }}
                        >
                            {ft.text}
                        </div>
                    ))}

                    <div 
                        ref={playerDomRef}
                        className="absolute bottom-24 text-6xl transform -translate-x-1/2 transition-transform duration-75 pointer-events-none drop-shadow-[0_0_15px_rgba(255,255,255,0.4)]"
                        style={{ left: `${playerPos}%` }}
                    >
                        üêà‚Äç‚¨õ
                    </div>

                    <div className="absolute bottom-0 w-full h-24 bg-gradient-to-t from-slate-900 to-transparent flex justify-around items-end pb-4 opacity-50 pointer-events-none">
                        <Tent className="text-slate-600 w-12 h-12" />
                        <div className="text-slate-600">üî•</div>
                        <Tent className="text-slate-600 w-12 h-12" />
                    </div>
                </div>
            );
        };

        // ==========================================
        // PAGE: ADVENTURE GAME (Hidden Logic)
        // ==========================================
        const RPGGame = ({ onFinish, isActive }) => {
            const MAP_COLS = 12;
            const MAP_ROWS = 12;
            const INITIAL_MISSIONS = [
                { id: 1, text: "Collect 4 Nectarines", type: 'collect', target: 'üçë', current: 0, required: 4, completed: false },
                { id: 2, text: "Defeat 3 Enemies", type: 'defeat', target: 'any', current: 0, required: 3, completed: false },
                { id: 3, text: "Reach Level 3", type: 'level', target: 'lvl', current: 1, required: 3, completed: false },
                { id: 4, text: "Defeat the Calamari King", type: 'defeat', target: 'Calamari', current: 0, required: 1, completed: false },
                { id: 5, text: "Eat a Cookie", type: 'collect', target: 'üç™', current: 0, required: 1, completed: false }
            ];

            const [player, setPlayer] = useState({ x: 1, y: 1, hp: 50, maxHp: 50, xp: 0, level: 1, attack: 10 });
            const [mapGrid, setMapGrid] = useState([]); // Static terrain
            const [entities, setEntities] = useState([]);
            const [missions, setMissions] = useState(INITIAL_MISSIONS);
            const [gameState, setGameState] = useState('roaming'); // roaming, battle, victory
            const [battleState, setBattleState] = useState(null); 
            const [message, setMessage] = useState("Welcome to the Adventure!");
            const [villainsDefeated, setVillainsDefeated] = useState(0);
            const [bossSpawned, setBossSpawned] = useState(false);
            const [showBossWarning, setShowBossWarning] = useState(false);

            // Initialize Map Once
            useEffect(() => {
                generateMap();
            }, []);

            const generateMap = () => {
                const grid = [];
                const newEntities = [];
                let id = 0;

                // 1. Generate Static Grid (Grass, Obstacles)
                for(let y=0; y<MAP_ROWS; y++) {
                    for(let x=0; x<MAP_COLS; x++) {
                        const cell = { x, y, isObstacle: false, decoration: null };
                        
                        // Edges as obstacles (fences)
                        if (x === 0 || x === MAP_COLS-1 || y === 0 || y === MAP_ROWS-1) {
                            cell.isObstacle = true;
                            cell.decoration = 'üå≤'; // Trees on border
                        } else {
                            // Random obstacles inside
                            if (Math.random() < 0.15 && !(x===1 && y===1)) { // Don't block spawn
                                cell.isObstacle = true;
                                cell.decoration = Math.random() > 0.5 ? 'ü™®' : 'üå≤';
                            } else {
                                // Grass decorations
                                if (Math.random() > 0.8) cell.decoration = 'üå±';
                                if (Math.random() > 0.9) cell.decoration = 'üåø';
                                if (Math.random() > 0.95) cell.decoration = 'üå∏';
                            }
                        }
                        grid.push(cell);
                    }
                }
                setMapGrid(grid);

                // Helper to get free random coord
                const getFreeCoord = () => {
                    let tries = 0;
                    while(tries < 100) {
                        const x = Math.floor(Math.random() * (MAP_COLS - 2)) + 1;
                        const y = Math.floor(Math.random() * (MAP_ROWS - 2)) + 1;
                        const idx = y * MAP_COLS + x;
                        if (!grid[idx].isObstacle && !(x===1 && y===1) && !newEntities.find(e => e.x===x && e.y===y)) {
                            return { x, y };
                        }
                        tries++;
                    }
                    return { x: 1, y: 1 }; // Fallback
                };

                // Spawn Items
                for(let i=0; i<6; i++) {
                    const pos = getFreeCoord();
                    newEntities.push({ id: id++, ...pos, type: 'item', content: 'üçë', name: 'Nectarine', value: 10 });
                }
                for(let i=0; i<3; i++) {
                    const pos = getFreeCoord();
                    newEntities.push({ id: id++, ...pos, type: 'item', content: 'üç™', name: 'Cookie', value: 5 }); 
                }

                // Spawn Normal Villains ONLY first
                const villainTypes = [
                    { content: '‚õàÔ∏è', name: 'Bad Vibe', hp: 30, xp: 40 },
                    { content: 'ü¶†', name: 'Germ', hp: 20, xp: 25 },
                    { content: 'ü•Ä', name: 'Wilted Flower', hp: 25, xp: 30 }
                ];

                for(let i=0; i<6; i++) {
                    const pos = getFreeCoord();
                    const type = villainTypes[Math.floor(Math.random() * villainTypes.length)];
                    newEntities.push({ id: id++, ...pos, type: 'enemy', ...type, maxHp: type.hp, attack: 5 });
                }

                setEntities(newEntities);
            };

            // Mission Logic
            const updateMission = (type, target, amount = 1) => {
                setMissions(prev => {
                    const next = prev.map(m => {
                        if (m.completed) return m;
                        if (m.type === type) {
                            if (type === 'collect' && target === m.target) {
                                return { ...m, current: Math.min(m.current + amount, m.required) };
                            }
                            if (type === 'defeat') {
                                if (m.target === 'any' || m.target === target) {
                                     return { ...m, current: Math.min(m.current + amount, m.required) };
                                }
                            }
                            if (type === 'level') {
                                return { ...m, current: Math.max(m.current, amount) };
                            }
                        }
                        return m;
                    });
                    return next.map(m => ({ ...m, completed: m.current >= m.required }));
                });
            };

            useEffect(() => {
                if (missions.every(m => m.completed) && gameState !== 'victory') {
                    setGameState('victory');
                }
            }, [missions, gameState]);

            // Boss Spawning Logic
            useEffect(() => {
                if (villainsDefeated >= 2 && !bossSpawned) {
                    setBossSpawned(true);
                    setShowBossWarning(true);
                    setTimeout(() => setShowBossWarning(false), 3000);

                    // Spawn Calamari
                    const bossType = { content: 'ü¶ë', name: 'Calamari', hp: 100, xp: 500, isBoss: true }; // High HP
                    // Find spawn point far from player if possible, simply use free coord for now
                    // We need to access mapGrid state, which we can in setEntities updater if needed, but let's assume getFreeCoord logic isn't easily accessible here without recreating it or refactoring.
                    // Simplified: Spawn at fixed location (10, 10) if free, else random.
                    // To keep it simple, we'll append to entities.
                    
                    setEntities(prev => {
                         // Find a free spot
                         let spawnX = 10, spawnY = 10;
                         // Simple check against existing entities
                         while (prev.find(e => e.x === spawnX && e.y === spawnY)) {
                             spawnX = Math.floor(Math.random() * (MAP_COLS - 2)) + 1;
                             spawnY = Math.floor(Math.random() * (MAP_ROWS - 2)) + 1;
                         }
                         
                         return [...prev, { 
                             id: Date.now(), 
                             x: spawnX, 
                             y: spawnY, 
                             type: 'enemy', 
                             ...bossType, 
                             maxHp: bossType.hp, 
                             attack: 15 // Stronger attack
                         }];
                    });
                    
                    setMessage("A giant shadow covers the picnic...");
                }
            }, [villainsDefeated, bossSpawned]);


            const movePlayer = (dx, dy) => {
                if (gameState !== 'roaming') return;

                const newX = player.x + dx;
                const newY = player.y + dy;

                // Bounds & Obstacle Check
                if (newX < 0 || newX >= MAP_COLS || newY < 0 || newY >= MAP_ROWS) return;
                
                const targetCell = mapGrid[newY * MAP_COLS + newX];
                if (targetCell && targetCell.isObstacle) {
                    setMessage("Bonk! Something blocks the way.");
                    return;
                }

                // Entity Interaction
                const entityIndex = entities.findIndex(e => e.x === newX && e.y === newY);
                
                if (entityIndex >= 0) {
                    const entity = entities[entityIndex];
                    
                    if (entity.type === 'item') {
                        setMessage(`Found ${entity.name}!`);
                        if (entity.name === 'Cookie') {
                            setPlayer(p => ({ ...p, hp: Math.min(p.hp + 20, p.maxHp) }));
                            updateMission('collect', 'üç™', 1);
                            setMessage("Ate a cookie! HP recovered.");
                        } else {
                            updateMission('collect', entity.content, 1);
                        }
                        const newEnts = [...entities];
                        newEnts.splice(entityIndex, 1);
                        setEntities(newEnts);
                        setPlayer(prev => ({ ...prev, x: newX, y: newY }));
                    } else if (entity.type === 'enemy') {
                        setBattleState({
                            enemy: { ...entity, index: entityIndex },
                            log: [`A wild ${entity.name} appeared!`]
                        });
                        setGameState('battle');
                    }
                } else {
                    setPlayer(prev => ({ ...prev, x: newX, y: newY }));
                }
            };

            const battleAction = (action) => {
                if (!battleState) return;
                const { enemy } = battleState;
                let newEnemyHp = enemy.hp;
                let newPlayerHp = player.hp;
                let newLog = [...battleState.log];

                if (action === 'attack') {
                    const dmg = player.attack + Math.floor(Math.random() * 5);
                    newEnemyHp -= dmg;
                    newLog.push(`You scratched for ${dmg} damage!`);
                } else if (action === 'hiss') {
                    const dmg = player.attack * 1.5;
                    newEnemyHp -= dmg;
                    newLog.push(`You HISS loudly! ${dmg} damage!`);
                } else if (action === 'heal') {
                    const heal = 15;
                    newPlayerHp = Math.min(newPlayerHp + heal, player.maxHp);
                    newLog.push(`You purred and healed ${heal} HP.`);
                }

                if (newEnemyHp <= 0) {
                    newLog.push(`Defeated ${enemy.name}! +${enemy.xp} XP`);
                    const newXp = player.xp + enemy.xp;
                    let newLevel = player.level;
                    if (newXp >= 100 * player.level) {
                        newLevel += 1;
                        newLog.push(`Leveled Up! You are now level ${newLevel}!`);
                        updateMission('level', 'lvl', newLevel);
                    }
                    
                    setPlayer(p => ({ ...p, hp: newPlayerHp, xp: newXp, level: newLevel, maxHp: 50 + (newLevel-1)*10, attack: 10 + (newLevel-1)*5 }));
                    
                    const newEnts = [...entities];
                    newEnts.splice(enemy.index, 1);
                    setEntities(newEnts);
                    
                    updateMission('defeat', enemy.name, 1); // Specific target
                    updateMission('defeat', 'any', 1);      // Generic target
                    
                    // Increment villains defeated count for boss spawn logic
                    setVillainsDefeated(prev => prev + 1);

                    setTimeout(() => {
                        setGameState('roaming');
                        setBattleState(null);
                        setMessage("Victory! Back to exploring...");
                    }, 1500);
                } else {
                    const enemyDmg = Math.max(0, enemy.attack + Math.floor(Math.random() * 3) - (player.level));
                    newPlayerHp -= enemyDmg;
                    newLog.push(`${enemy.name} attacked you for ${enemyDmg} damage.`);

                    if (newPlayerHp <= 0) {
                        newLog.push("You fainted! Respawning...");
                        setTimeout(() => {
                            setPlayer(p => ({ ...p, x: 1, y: 1, hp: p.maxHp }));
                            setGameState('roaming');
                            setBattleState(null);
                            setMessage("Be careful next time!");
                        }, 2000);
                    }
                }

                setPlayer(p => ({ ...p, hp: newPlayerHp }));
                setBattleState(prev => ({
                    ...prev,
                    enemy: { ...prev.enemy, hp: newEnemyHp },
                    log: newLog.slice(-4)
                }));
            };

            return (
                <div className="h-full flex flex-col items-center justify-center p-2 bg-slate-900 relative w-full">
                    
                    {/* Compact HUD */}
                    <div className="w-full max-w-md flex justify-between items-center mb-2 bg-slate-800 p-2 rounded-lg border border-pink-500/30 text-xs">
                        <div className="flex flex-col">
                            <span className="text-pink-300 font-bold">LVL {player.level}</span>
                            <div className="w-20 h-1.5 bg-slate-700 rounded-full mt-1">
                                <div className="h-full bg-green-500 rounded-full" style={{width: `${(player.hp/player.maxHp)*100}%`}}></div>
                            </div>
                        </div>
                        <div className="text-slate-400 text-right truncate ml-2">
                            {missions.filter(m => !m.completed).length > 0 ? 
                                `Quest: ${missions.find(m => !m.completed)?.text}` : "All Done!"}
                        </div>
                    </div>

                    {/* Flexible Game Viewport */}
                    <div className="flex-1 w-full min-h-0 flex items-center justify-center">
                        <div className="aspect-square max-h-full max-w-full bg-emerald-900 rounded-xl border-4 border-slate-700 overflow-hidden shadow-2xl relative">
                            
                            {/* Boss Warning Pop-up */}
                            {showBossWarning && (
                                <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80 animate-in fade-in zoom-in duration-300">
                                    <h1 className="text-4xl font-black text-red-500 animate-pulse border-4 border-red-500 p-4 rounded-xl rotate-[-5deg] bg-slate-900">
                                        WARNING:<br/>BOSS APPROACHING!
                                    </h1>
                                </div>
                            )}

                            {/* Map Grid */}
                            {gameState === 'roaming' && (
                                <div className="absolute inset-0 grid bg-slate-700 gap-px border border-slate-700" style={{ 
                                    gridTemplateColumns: `repeat(${MAP_COLS}, 1fr)`, 
                                    gridTemplateRows: `repeat(${MAP_ROWS}, 1fr)` 
                                }}>
                                    {mapGrid.map((cell, i) => (
                                        <div key={i} className={`relative flex items-center justify-center ${cell.isObstacle ? 'bg-slate-800/50' : 'bg-green-800/40'}`}>
                                            {cell.decoration && <span style={{fontSize: 'clamp(8px, 1.5vw, 16px)'}} className="opacity-70">{cell.decoration}</span>}
                                        </div>
                                    ))}

                                    {entities.map(e => (
                                        <div key={e.id} className={`absolute flex items-center justify-center transition-all duration-300 transform hover:scale-110 z-10 ${e.isBoss ? 'boss-anim' : ''}`}
                                             style={{ 
                                                 width: e.isBoss ? `${(100/MAP_COLS)*3}%` : `${100/MAP_COLS}%`, // 3x size for boss
                                                 height: e.isBoss ? `${(100/MAP_ROWS)*3}%` : `${100/MAP_ROWS}%`,
                                                 left: `${(e.x/MAP_COLS)*100}%`, top: `${(e.y/MAP_ROWS)*100}%`,
                                                 fontSize: e.isBoss ? 'clamp(32px, 8vw, 64px)' : 'clamp(12px, 2.5vw, 24px)',
                                                 zIndex: e.isBoss ? 25 : 10
                                             }}>
                                            {e.content}
                                        </div>
                                    ))}

                                    <div className="absolute flex items-center justify-center transition-all duration-200 z-20"
                                         style={{ 
                                             width: `${100/MAP_COLS}%`, height: `${100/MAP_ROWS}%`,
                                             left: `${(player.x/MAP_COLS)*100}%`, top: `${(player.y/MAP_ROWS)*100}%`,
                                             fontSize: 'clamp(14px, 3vw, 28px)'
                                         }}>
                                        üêà‚Äç‚¨õ
                                    </div>
                                </div>
                            )}

                            {gameState === 'battle' && battleState && (
                                <div className="absolute inset-0 bg-slate-900/95 flex flex-col items-center justify-center p-4 animate-in fade-in z-30">
                                    <h3 className={`text-xl font-bold mb-4 animate-pulse ${battleState.enemy.isBoss ? 'text-red-600 text-3xl' : 'text-red-400'}`}>
                                        {battleState.enemy.isBoss ? 'BOSS BATTLE!' : 'BATTLE!'}
                                    </h3>
                                    
                                    <div className="flex justify-around w-full mb-4">
                                        <div className="text-center">
                                            <div className="text-3xl mb-1">üêà‚Äç‚¨õ</div>
                                            <div className="text-xs font-bold text-green-400">{player.hp} HP</div>
                                        </div>
                                        <div className="text-center">
                                            <div className={`mb-1 animate-bounce ${battleState.enemy.isBoss ? 'text-6xl' : 'text-3xl'}`}>{battleState.enemy.content}</div>
                                            <div className="text-xs font-bold text-red-400">{battleState.enemy.hp} HP</div>
                                        </div>
                                    </div>

                                    <div className="w-full bg-black/50 p-2 rounded mb-4 h-20 overflow-y-auto text-[10px] font-mono text-slate-300 border border-slate-700">
                                        {battleState.log.map((l, i) => <div key={i}>{l}</div>)}
                                    </div>

                                    <div className="grid grid-cols-2 gap-2 w-full text-xs">
                                        <button onClick={() => battleAction('attack')} className="p-2 bg-red-600 rounded font-bold hover:bg-red-500 flex items-center justify-center gap-1"><Sword size={12} /> Scratch</button>
                                        <button onClick={() => battleAction('hiss')} className="p-2 bg-orange-600 rounded font-bold hover:bg-orange-500 flex items-center justify-center gap-1"><Zap size={12}/> Hiss</button>
                                        <button onClick={() => battleAction('heal')} className="p-2 bg-green-600 rounded font-bold hover:bg-green-500 col-span-2 flex items-center justify-center gap-1"><Heart size={12} /> Purr</button>
                                    </div>
                                </div>
                            )}

                            {gameState === 'victory' && (
                                <div className="absolute inset-0 bg-pink-900/90 flex flex-col items-center justify-center p-6 text-center animate-in zoom-in z-40">
                                    <Trophy size={48} className="text-yellow-400 mb-2" />
                                    <h2 className="text-2xl font-bold text-white mb-2">Adventure Complete!</h2>
                                    <p className="text-pink-200 text-sm mb-4">You've cleared all challenges.</p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Compact Controls */}
                    {gameState === 'roaming' && (
                        <div className="shrink-0 mt-2 w-full flex flex-col items-center gap-2">
                             <div className="text-pink-300 font-mono text-xs h-4 overflow-hidden w-full text-center">
                                {message}
                            </div>
                            <div className="grid grid-cols-3 gap-1">
                                <div></div>
                                <button onClick={() => movePlayer(0, -1)} className="w-12 h-12 bg-slate-700 rounded-lg active:bg-pink-500 transition-colors flex items-center justify-center text-xl shadow-lg border border-slate-600">‚¨ÜÔ∏è</button>
                                <div></div>
                                <button onClick={() => movePlayer(-1, 0)} className="w-12 h-12 bg-slate-700 rounded-lg active:bg-pink-500 transition-colors flex items-center justify-center text-xl shadow-lg border border-slate-600">‚¨ÖÔ∏è</button>
                                <div className="flex items-center justify-center"><div className="w-2 h-2 bg-pink-500/50 rounded-full"></div></div>
                                <button onClick={() => movePlayer(1, 0)} className="w-12 h-12 bg-slate-700 rounded-lg active:bg-pink-500 transition-colors flex items-center justify-center text-xl shadow-lg border border-slate-600">‚û°Ô∏è</button> <div></div> <button onClick={() => movePlayer(0, 1)} className="w-12 h-12 bg-slate-700 rounded-lg active:bg-pink-500 transition-colors flex items-center justify-center text-xl shadow-lg border border-slate-600">‚¨áÔ∏è</button> <div></div> </div> </div> )} </div> ); };

        const ConstellationIllustration = ({ title, icon, data }) => {
            const hasRealData = !!data;
            const seed = title.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const random = (offset = 0) => {
                const x = Math.sin(seed + offset) * 10000;
                return x - Math.floor(x);
            };

            let stars = [];
            let lines = [];

            if (hasRealData) {
                stars = data.stars;
                lines = data.lines;
            } else {
                const starCount = 5 + Math.floor(random(1) * 5);
                for(let i=0; i<starCount; i++) {
                    stars.push({
                        x: 15 + random(i * 2) * 70,
                        y: 15 + random(i * 2 + 1) * 70,
                        size: 2 + random(i * 3) * 2
                    });
                }
                const sortedStars = [...stars].sort((a,b) => a.x - b.x);
                for(let i=0; i<sortedStars.length-1; i++) {
                    lines.push({ x1: sortedStars[i].x, y1: sortedStars[i].y, x2: sortedStars[i+1].x, y2: sortedStars[i+1].y });
                }
                stars = sortedStars;
            }

            return (
                <div className="w-full h-64 bg-slate-950 rounded-2xl relative overflow-hidden mb-6 border-2 border-slate-700 shadow-inner group">
                    <div className="absolute inset-0 opacity-40 transition-opacity duration-1000" 
                            style={{
                                background: `radial-gradient(circle at ${random(10)*100}% ${random(11)*100}%, rgba(147, 51, 234, 0.3), transparent 60%),
                                            radial-gradient(circle at ${random(12)*100}% ${random(13)*100}%, rgba(236, 72, 153, 0.2), transparent 50%)`
                            }}
                    />
                    <div className="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none select-none grayscale contrast-150 transform scale-150 group-hover:scale-125 transition-transform duration-1000">
                        <span className="text-9xl filter blur-sm">{icon}</span>
                    </div>
                    <svg className="w-full h-full absolute inset-0 p-4 pointer-events-none">
                        {lines.map((line, i) => (
                            <line 
                                key={i}
                                x1={`${line.x1}%`} y1={`${line.y1}%`}
                                x2={`${line.x2}%`} y2={`${line.y2}%`}
                                stroke="rgba(255,255,255,0.4)"
                                strokeWidth="1.5"
                                strokeDasharray="5,5"
                                className="animate-pulse"
                                style={{ animationDuration: '3s' }}
                            />
                        ))}
                        {stars.map((s, i) => (
                            <circle 
                                key={i} 
                                cx={`${s.x}%`} 
                                cy={`${s.y}%`} 
                                r={s.size || (3 + random(i)*2)} 
                                fill="white" 
                                className="drop-shadow-[0_0_4px_rgba(255,255,255,0.8)]"
                            >
                                <animate attributeName="opacity" values="0.5;1;0.5" dur={`${2 + random(i)}s`} repeatCount="indefinite" />
                            </circle>
                        ))}
                    </svg>
                    <div className="absolute bottom-2 right-4 text-xs text-slate-500 font-mono opacity-50">
                        {hasRealData ? "ASTRONOMICAL DATA" : `ARTISTIC REP. FIG. ${seed % 100}`}
                    </div>
                </div>
            )
        }

        const ConstellationGallery = () => {
            const [activeConstellation, setActiveConstellation] = useState(null);
            const [currentTracks, setCurrentTracks] = useState([]);
            const [currentConstellations, setCurrentConstellations] = useState([]);

            const allConstellations = [
                { 
                    id: 1, icon: 'üèπ', title: 'Orion', 
                    text: 'The Hunter. Famous for his belt of three stars. Battling Taurus in the winter sky.',
                    data: {
                        stars: [{x: 25, y: 20, size: 4}, {x: 75, y: 25, size: 4}, {x: 45, y: 50, size: 3}, {x: 50, y: 50, size: 3}, {x: 55, y: 50, size: 3}, {x: 30, y: 80, size: 4}, {x: 70, y: 85, size: 5}],
                        lines: [{x1: 25, y1: 20, x2: 45, y2: 50}, {x1: 75, y1: 25, x2: 55, y2: 50}, {x1: 45, y1: 50, x2: 50, y2: 50}, {x1: 50, y1: 50, x2: 55, y2: 50}, {x1: 45, y1: 50, x2: 30, y2: 80}, {x1: 55, y1: 50, x2: 70, y2: 85}]
                    }
                },
                { 
                    id: 2, icon: 'üêª', title: 'Ursa Major', 
                    text: 'The Great Bear (Big Dipper). Use the pointer stars to find the North Star.',
                    data: {
                        stars: [{x: 10, y: 30, size: 3}, {x: 25, y: 25, size: 3}, {x: 35, y: 35, size: 3}, {x: 50, y: 45, size: 3}, {x: 75, y: 45, size: 3}, {x: 75, y: 70, size: 3}, {x: 50, y: 70, size: 3}],
                        lines: [{x1: 10, y1: 30, x2: 25, y2: 25}, {x1: 25, y1: 25, x2: 35, y2: 35}, {x1: 35, y1: 35, x2: 50, y2: 45}, {x1: 50, y1: 45, x2: 75, y2: 45}, {x1: 75, y1: 45, x2: 75, y2: 70}, {x1: 75, y1: 70, x2: 50, y2: 70}, {x1: 50, y1: 70, x2: 50, y2: 45}]
                    }
                },
                { 
                    id: 3, icon: 'üëë', title: 'Cassiopeia', 
                    text: 'The Queen. A distinctive "W" or "M" shape high in the northern sky.',
                    data: {
                        stars: [{x: 15, y: 30, size: 3}, {x: 35, y: 60, size: 3}, {x: 50, y: 40, size: 4}, {x: 65, y: 60, size: 3}, {x: 85, y: 30, size: 3}],
                        lines: [{x1: 15, y1: 30, x2: 35, y2: 60}, {x1: 35, y1: 60, x2: 50, y2: 40}, {x1: 50, y1: 40, x2: 65, y2: 60}, {x1: 65, y1: 60, x2: 85, y2: 30}]
                    }
                },
                { 
                    id: 4, icon: 'üêï', title: 'Canis Major', 
                    text: 'The Great Dog. Faithful companion to Orion. Home to Sirius, the brightest star.',
                    data: {
                        stars: [{x: 45, y: 30, size: 5}, {x: 55, y: 32, size: 3}, {x: 65, y: 55, size: 4}, {x: 60, y: 70, size: 3}, {x: 30, y: 60, size: 3}],
                        lines: [{x1: 45, y1: 30, x2: 65, y2: 55}, {x1: 45, y1: 30, x2: 55, y2: 32}, {x1: 65, y1: 55, x2: 60, y2: 70}, {x1: 65, y1: 55, x2: 30, y2: 60}]
                    }
                }
            ];
            const shuffleTracks = () => { const shuffled = [...MUSIC_POOL].sort(() => 0.5 - Math.random()); setCurrentTracks(shuffled.slice(0, 4)); };
            const shuffleConstellations = () => { const shuffled = [...allConstellations].sort(() => 0.5 - Math.random()); setCurrentConstellations(shuffled.slice(0, 4)); };
            useEffect(() => { shuffleTracks(); shuffleConstellations(); }, []);
            return ( <div className="p-6 max-w-2xl mx-auto pb-24"> <h2 className="text-3xl font-serif text-center text-pink-200 mb-8 border-b border-slate-700 pb-4"> You as a Constellation </h2> <div className="bg-slate-800/50 rounded-xl p-4 mb-8 border border-slate-700 backdrop-blur-sm relative overflow-hidden group"> <div className="absolute top-0 right-0 p-2 opacity-50 group-hover:opacity-100 transition-opacity z-10"> <button onClick={shuffleTracks} className="p-2 bg-black/40 hover:bg-pink-500 rounded-full transition-colors" title="Shuffle Songs"> <RefreshCw size={16} className="text-white" /> </button> </div> <div className="flex items-center gap-4 mb-4"> <div className="w-16 h-16 bg-gradient-to-br from-pink-500 to-purple-900 rounded-lg flex items-center justify-center animate-pulse"> <Music className="text-white w-8 h-8" /> </div> <div> <h3 className="text-white font-bold">Midnight Mixtape</h3> <p className="text-pink-400 text-sm">Music I listen to when I'm thinking of you</p> </div> </div> <div className="space-y-3"> {currentTracks.map((trackId, i) => ( <iframe key={i} style={{ borderRadius: '12px' }} src={`https://open.spotify.com/embed/track/${trackId}?utm_source=generator&theme=0`} width="100%" height="80" frameBorder="0" allowFullScreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy" className="bg-slate-900" /> ))} </div> </div> <div className="flex justify-between items-center mb-4 px-2"> <h3 className="text-pink-200 font-bold text-lg">Star Map</h3> <button onClick={shuffleConstellations} className="p-2 bg-slate-800 hover:bg-pink-600/50 rounded-full transition-colors flex items-center gap-2 text-xs text-slate-400 hover:text-white"> <RefreshCw size={14} /> Shuffle Stars </button> </div> <div className="grid grid-cols-2 gap-4"> {currentConstellations.map((c) => ( <button key={c.id} onClick={() => setActiveConstellation(c)} className="p-4 bg-slate-800/80 rounded-xl border border-slate-700 hover:border-pink-500/50 transition-all hover:scale-105 text-left group"> <div className="text-3xl mb-2 group-hover:animate-bounce shadow-white drop-shadow-md">{c.icon}</div> <h3 className="text-pink-200 font-bold text-sm">{c.title}</h3> </button> ))} </div> {activeConstellation && ( <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4" onClick={() => setActiveConstellation(null)}> <div className="bg-slate-900 border border-pink-500 rounded-2xl p-6 max-w-sm w-full relative transform scale-100 transition-transform flex flex-col items-center"> <button className="absolute top-2 right-2 text-slate-500 hover:text-white z-10"><X size={20}/></button> <ConstellationIllustration title={activeConstellation.title} icon={activeConstellation.icon} data={activeConstellation.data} /> <h3 className="text-2xl font-serif font-bold text-pink-400 mb-2 text-center">{activeConstellation.title}</h3> <p className="text-slate-300 text-center leading-relaxed text-sm mb-4">{activeConstellation.text}</p> <div className="mt-2 text-center text-xs text-slate-600">Tap anywhere to close</div> </div> </div> )} </div> );
        };

        const LoveLetter = () => {
            return ( <div className="min-h-[60vh] flex flex-col items-center justify-center p-8 text-center animate-in fade-in duration-1000"> <div className="w-32 h-32 rounded-full overflow-hidden border-4 border-pink-500 shadow-[0_0_30px_rgba(236,72,153,0.6)] mb-8 bg-slate-800 flex items-center justify-center"> <span className="text-6xl">üñ§</span> </div> <h1 className="text-4xl font-serif text-white mb-6">For the hottest black pantheress</h1> <div className="max-w-md bg-white/5 backdrop-blur-md p-6 rounded-xl border border-white/10 text-lg leading-relaxed text-pink-100 font-serif italic"> <p> I can't get over your dark aesthetic, your obsession with nectarines, and the way you look at me when I say something you like. I melt everytime you whisper my name or say that you want me. Keep s(p)it(t)ing on my face pls ü´† </p> </div> <div className="mt-8 text-sm text-slate-500 font-mono"> coded with ‚ù§Ô∏è by Banos </div> </div> );
        };

        const DailyPoem = () => {
             const [viewMode, setViewMode] = useState('local'); // 'local' or 'external'
             const [todayPoem, setTodayPoem] = useState(POEMS[0]);
             const [externalPoem, setExternalPoem] = useState(null);
             const [loading, setLoading] = useState(false);

             useEffect(() => {
                 const now = new Date();
                 const start = new Date(now.getFullYear(), 0, 0);
                 const diff = now - start;
                 const oneDay = 1000 * 60 * 60 * 24;
                 const day = Math.floor(diff / oneDay);
                 setTodayPoem(POEMS[day % POEMS.length]);
             }, []);

             const shufflePoem = () => {
                 setTodayPoem(POEMS[Math.floor(Math.random() * POEMS.length)]);
             };
             
             const fetchExternalPoem = async () => {
                 setLoading(true);
                 try {
                     const response = await fetch('https://poetrydb.org/random');
                     const data = await response.json();
                     if (data && data.length > 0) setExternalPoem(data[0]);
                 } catch (error) { console.error("Failed to fetch poem", error); } finally { setLoading(false); }
             };

             useEffect(() => {
                 if (viewMode === 'external' && !externalPoem) fetchExternalPoem();
             }, [viewMode]);

             return (
                 <div className="h-full flex flex-col items-center justify-center p-4 animate-in fade-in duration-1000">
                     <div className="flex bg-slate-800 rounded-full p-1 mb-4 border border-slate-700 shadow-lg">
                        <button onClick={() => setViewMode('local')} className={`px-6 py-2 rounded-full text-sm font-bold transition-all ${viewMode === 'local' ? 'bg-pink-600 text-white' : 'text-slate-400 hover:text-white'}`}>Classic</button>
                        <button onClick={() => setViewMode('external')} className={`px-6 py-2 rounded-full text-sm font-bold transition-all ${viewMode === 'external' ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:text-white'}`}>Discover</button>
                     </div>

                     <div className="w-full max-w-2xl bg-slate-800/50 border border-slate-700 rounded-2xl shadow-2xl relative overflow-hidden flex flex-col h-[75vh]">
                         <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-500 z-10"></div>
                         
                         {viewMode === 'local' ? (
                             <>
                                 <button onClick={shufflePoem} className="absolute top-4 right-4 p-2 text-slate-500 hover:text-white z-20 bg-slate-800/50 rounded-full"><RefreshCw size={18} /></button>
                                 <div className="p-8 flex flex-col h-full">
                                     <div className="mb-6 flex-shrink-0 text-center">
                                         <h2 className="text-2xl font-serif font-bold text-pink-200 mb-2">{todayPoem.title}</h2>
                                         <p className="text-sm text-slate-400 uppercase tracking-widest">by {todayPoem.author}</p>
                                     </div>
                                     <div className="font-serif text-slate-300 leading-relaxed text-lg italic space-y-2 overflow-y-auto scrollbar-hide flex-1 pb-4 px-2 text-center">
                                         {todayPoem.lines.map((line, i) => <p key={i} className={line === "" ? "h-4" : ""}>{line}</p>)}
                                     </div>
                                     <div className="mt-4 flex-shrink-0 flex justify-center"><Feather className="text-pink-500/50 w-6 h-6" /></div>
                                 </div>
                             </>
                         ) : (
                             <div className="p-8 flex flex-col h-full relative">
                                 <button onClick={fetchExternalPoem} className="absolute top-4 right-4 p-2 text-slate-500 hover:text-white z-20 bg-slate-800/50 rounded-full"><RefreshCw size={18} className={loading ? "animate-spin" : ""} /></button>
                                 {loading ? (
                                     <div className="flex items-center justify-center h-full text-slate-400 font-mono animate-pulse">Fetching inspiration...</div>
                                 ) : externalPoem ? (
                                     <>
                                         <div className="mb-6 flex-shrink-0 text-center">
                                             <h2 className="text-2xl font-serif font-bold text-indigo-200 mb-2">{externalPoem.title}</h2>
                                             <p className="text-sm text-slate-400 uppercase tracking-widest">by {externalPoem.author}</p>
                                         </div>
                                         <div className="font-serif text-slate-300 leading-relaxed text-lg italic space-y-2 overflow-y-auto scrollbar-hide flex-1 pb-4 px-2 text-center">
                                             {externalPoem.lines.map((line, i) => <p key={i} className={line === "" ? "h-4" : ""}>{line}</p>)}
                                         </div>
                                         <div className="mt-4 flex-shrink-0 flex justify-center text-xs text-slate-500 font-mono">Source: PoetryDB.org</div>
                                     </>
                                 ) : (
                                     <div className="flex flex-col items-center justify-center h-full text-slate-400 gap-4"><p>Could not fetch a poem.</p><button onClick={fetchExternalPoem} className="px-4 py-2 bg-indigo-600 rounded-full text-white text-sm">Try Again</button></div>
                                 )}
                             </div>
                         )}
                     </div>
                 </div>
             );
        };

        const ThoughtShrinker = () => {
             const [thought, setThought] = useState("");
             const [isReleased, setIsReleased] = useState(false);
             const [message, setMessage] = useState("");
             const [fade, setFade] = useState(false); 
             const [containerOpacity, setContainerOpacity] = useState(1); 
             const [timeLeft, setTimeLeft] = useState(60);
             const [titleText, setTitleText] = useState("What's on your mind?");
             const [isGriefMode, setIsGriefMode] = useState(false);

             useEffect(() => {
                 if (isReleased) {
                     setContainerOpacity(1); 
                     setTimeLeft(60);
                     
                     const griefKeywords = ["autn", "nopi", "aunt", "miss her", "death", "relative", "loss", "grief", "die"];
                     const isGrief = griefKeywords.some(keyword => thought.toLowerCase().includes(keyword));
                     setIsGriefMode(isGrief);

                     const normalMessages = [
                         "Take a deep breath...",
                         "You are safe here...",
                         "Let the thought drift away...",
                         "The universe is so big...",
                         "It's getting smaller...",
                         "Just a speck in the stars..."
                     ];

                     const griefMessages = [
                         "This love is real...",
                         "She is part of the stars now...",
                         "It's okay to miss her...",
                         "You carry her light...",
                         "Breathe through the memory...",
                         "Love never fades..."
                     ];
                     
                     const messages = isGrief ? griefMessages : normalMessages;
                     
                     let msgIndex = 0;
                     setMessage(messages[0]); 
                     setFade(true);

                     const msgInterval = setInterval(() => {
                         setFade(false); 
                         setTimeout(() => {
                             msgIndex++;
                             if (msgIndex < messages.length) {
                                 setMessage(messages[msgIndex]);
                                 setFade(true); 
                             }
                         }, 1000); 
                     }, 9000); 

                     const timerInterval = setInterval(() => {
                         setTimeLeft(prev => {
                             if (prev <= 1) return 0;
                             return prev - 1;
                         });
                     }, 1000);

                     const endTimeout = setTimeout(() => {
                         clearInterval(msgInterval);
                         clearInterval(timerInterval);
                         setFade(false); 
                         
                         setTimeout(() => {
                             setMessage(isGrief ? "She is always with you." : "You can contact me whenever");
                             setFade(true);
                             
                             setTimeout(() => {
                                 setContainerOpacity(0);
                                 
                                 setTimeout(() => {
                                     setThought("");
                                     setIsReleased(false);
                                     setMessage("");
                                     setTitleText("What else bothers you?");
                                     setIsGriefMode(false);
                                     setFade(false);
                                 }, 2000); 
                             }, 5000); 
                         }, 1000);
                     }, 60000);

                     return () => {
                         clearInterval(msgInterval);
                         clearInterval(timerInterval);
                         clearTimeout(endTimeout);
                     };
                 }
             }, [isReleased]);

             return (
                 <div className="h-full flex flex-col items-center justify-center p-6 text-center relative overflow-hidden">
                    <button 
                        className="absolute top-4 right-4 z-50 p-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors text-white"
                        title="Mute"
                    >
                        <VolumeX size={20} />
                    </button>

                    {!isReleased ? (
                        <div className="z-10 w-full max-w-lg animate-in fade-in zoom-in duration-1000">
                             <h2 className="text-3xl md:text-4xl font-serif text-pink-200 mb-8 drop-shadow-md">{titleText}</h2>
                             <div className="relative group mx-auto w-full max-w-sm aspect-square">
                                 <div className="absolute inset-0 bg-pink-500/20 blur-2xl rounded-full group-hover:bg-pink-500/30 transition-all duration-1000"></div>
                                 <div className="relative bg-white text-slate-900 border-4 border-pink-200/50 rounded-full w-full h-full flex items-center justify-center shadow-[0_0_60px_rgba(236,72,153,0.4)] p-8">
                                     <textarea 
                                        value={thought}
                                        onChange={(e) => setThought(e.target.value)}
                                        placeholder="Put a stressful thought here..."
                                        className="w-full h-full bg-transparent text-center text-slate-800 placeholder-slate-400 resize-none outline-none font-serif text-xl md:text-2xl flex items-center justify-center pt-10"
                                        maxLength={140}
                                     />
                                 </div>
                             </div>
                             <button 
                                onClick={() => thought.trim() && setIsReleased(true)}
                                disabled={!thought.trim()}
                                className="mt-12 px-10 py-4 bg-white/10 hover:bg-white/20 text-white text-lg rounded-full transition-all disabled:opacity-50 disabled:cursor-not-allowed border border-white/20 backdrop-blur-sm shadow-lg font-serif tracking-wide"
                             >
                                Release to the Stars
                             </button>
                        </div>
                    ) : (
                        <div 
                            className="absolute inset-0 flex items-center justify-center z-20 pointer-events-none transition-opacity duration-[2000ms]"
                            style={{ opacity: containerOpacity }}
                        >
                            <div className="text-center w-full h-full relative">
                                <div 
                                    className="bg-white text-slate-900 rounded-full p-6 aspect-square flex items-center justify-center font-serif text-sm w-80 h-80 mx-auto shadow-[0_0_120px_white]"
                                    style={{
                                        animation: isGriefMode 
                                            ? 'ascend-bright 60s forwards ease-in-out' 
                                            : 'float-away 60s forwards ease-in-out'
                                    }}
                                >
                                    {thought}
                                </div>
                                
                                <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full flex justify-center pointer-events-none px-4">
                                     <p 
                                        className={`text-2xl md:text-3xl text-pink-100 font-serif italic bg-slate-900/60 px-8 py-4 rounded-2xl shadow-2xl backdrop-blur-md border border-white/10 transition-opacity duration-1000 ${fade ? 'opacity-100' : 'opacity-0'}`}
                                     >
                                         {message}
                                     </p>
                                </div>
                                
                                <div className="absolute bottom-24 left-0 right-0 text-center pointer-events-none">
                                     <span className="font-mono text-pink-300 text-xl font-bold opacity-80 block tracking-widest">00:{timeLeft < 10 ? `0${timeLeft}` : timeLeft}</span>
                                </div>
                            </div>
                        </div>
                    )}
                 </div>
             )
        }

        const RockPaperScissors = ({ user }) => {
            const [roomCode, setRoomCode] = useState('');
            const [joinedRoom, setJoinedRoom] = useState(null);
            const [playerId, setPlayerId] = useState(null); // 'player1' or 'player2'
            const [gameState, setGameState] = useState(null); // The firestore doc data
            const [statusMessage, setStatusMessage] = useState('');
            const unsubscribeRef = useRef(null);

            const choices = [
                { id: 'rock', icon: 'ü™®' },
                { id: 'paper', icon: 'üìÑ' },
                { id: 'scissors', icon: '‚úÇÔ∏è' }
            ];

            useEffect(() => {
                return () => {
                    if (unsubscribeRef.current) unsubscribeRef.current();
                }
            }, []);

            // Safely get Firebase modules
            const getModules = () => window.firebaseModules || {};

            const joinRoom = async () => {
                if (!roomCode) return;
                
                const modules = getModules();
                if (!fb.db || !user || !modules.doc) {
                    setStatusMessage("Connecting to server...");
                    return;
                }

                const { doc, getDoc, setDoc, updateDoc, onSnapshot } = modules;
                const uid = user.uid;
                const roomRef = doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'rps_matches', roomCode);
                
                try {
                    const roomSnap = await getDoc(roomRef);

                    if (!roomSnap.exists()) {
                        // Create room as player 1
                        await setDoc(roomRef, {
                            player1: uid,
                            player2: null,
                            p1Choice: null,
                            p2Choice: null,
                            p1Score: 0,
                            p2Score: 0,
                            round: 1
                        });
                        setPlayerId('player1');
                    } else {
                        const data = roomSnap.data();
                        if (data.player1 === uid) {
                            setPlayerId('player1'); // Rejoining
                        } else if (!data.player2 || data.player2 === uid) {
                            // Join as player 2
                            if (data.player2 !== uid) {
                                await updateDoc(roomRef, { player2: uid });
                            }
                            setPlayerId('player2');
                        } else {
                            setStatusMessage("Room is full!");
                            return;
                        }
                    }

                    setJoinedRoom(roomCode);
                    
                    // Listen for updates
                    unsubscribeRef.current = onSnapshot(roomRef, (doc) => {
                        if (doc.exists()) {
                            setGameState(doc.data());
                        }
                    });

                } catch (error) {
                    console.error("Error joining room:", error);
                    setStatusMessage("Error joining room.");
                }
            };

            const makeMove = async (choiceId) => {
                if (!joinedRoom || !playerId) return;
                const modules = getModules();
                if (!modules.doc) return;
                
                const { doc, updateDoc } = modules;
                const roomRef = doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'rps_matches', joinedRoom);
                
                const updateField = playerId === 'player1' ? 'p1Choice' : 'p2Choice';
                await updateDoc(roomRef, { [updateField]: choiceId });
            };

            const resetRound = async () => {
                if (!joinedRoom) return;
                const modules = getModules();
                if (!modules.doc) return;

                const { doc, updateDoc } = modules;
                const roomRef = doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'rps_matches', joinedRoom);
                
                await updateDoc(roomRef, { 
                    p1Choice: null, 
                    p2Choice: null 
                });
            };
            
            // Helper to get winner text
            const getResultText = () => {
                if (!gameState || !gameState.p1Choice || !gameState.p2Choice) return "Waiting...";
                
                const p1 = gameState.p1Choice;
                const p2 = gameState.p2Choice;
                
                if (p1 === p2) return "It's a Tie!";
                
                if (
                    (p1 === 'rock' && p2 === 'scissors') ||
                    (p1 === 'paper' && p2 === 'rock') ||
                    (p1 === 'scissors' && p2 === 'paper')
                ) {
                    return "Player 1 Wins!";
                } else {
                    return "Player 2 Wins!";
                }
            };

            // --- RENDER: LOBBY ---
            if (!joinedRoom) {
                return (
                    <div className="h-full flex flex-col items-center justify-center p-6 text-center animate-in fade-in">
                        <h2 className="text-3xl font-bold text-pink-400 mb-8">Multiplayer RPS</h2>
                        
                        <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 w-full max-w-xs">
                            <label className="block text-slate-400 text-sm mb-2">Secret Code</label>
                            <input 
                                type="text" 
                                value={roomCode}
                                onChange={(e) => setRoomCode(e.target.value.toLowerCase())}
                                placeholder="e.g. bitch"
                                className="w-full bg-slate-900 text-white border border-slate-600 rounded-lg p-3 text-center mb-4 focus:border-pink-500 outline-none uppercase font-bold tracking-widest"
                            />
                            <button 
                                onClick={joinRoom}
                                disabled={!roomCode}
                                className="w-full bg-pink-600 hover:bg-pink-500 text-white font-bold py-3 rounded-lg transition-colors disabled:opacity-50"
                            >
                                Join Room
                            </button>
                            {statusMessage && <p className="text-red-400 text-xs mt-2">{statusMessage}</p>}
                        </div>
                    </div>
                );
            }

            // --- RENDER: GAME ---
            const myChoice = playerId === 'player1' ? gameState?.p1Choice : gameState?.p2Choice;
            const opponentChoice = playerId === 'player1' ? gameState?.p2Choice : gameState?.p1Choice;
            const bothChose = gameState?.p1Choice && gameState?.p2Choice;

            return (
                <div className="h-full flex flex-col items-center justify-center p-6 text-center relative animate-in fade-in">
                    
                     <div className="absolute top-4 left-4">
                        <button onClick={() => setJoinedRoom(null)} className="text-slate-500 hover:text-white flex items-center gap-1 text-xs">
                           <X size={14}/> Leave
                        </button>
                     </div>

                     <div className="mb-8">
                         <span className="text-pink-300 font-bold tracking-widest uppercase">ROOM: {joinedRoom}</span>
                     </div>
                     
                    <div className="mb-12 relative w-full max-w-sm flex justify-between items-center px-8">
                         {/* Player (You) */}
                         <div className="flex flex-col items-center gap-2">
                             <div className="text-slate-400 text-xs font-bold">YOU</div>
                             <div className={`w-20 h-20 bg-slate-800 rounded-2xl flex items-center justify-center text-4xl border-2 ${myChoice ? 'border-pink-500' : 'border-slate-700'}`}>
                                 {myChoice ? (choices.find(c=>c.id===myChoice).icon) : '?'}
                             </div>
                         </div>

                         <div className="text-2xl font-black text-slate-600">VS</div>

                         {/* Opponent */}
                         <div className="flex flex-col items-center gap-2">
                             <div className="text-slate-400 text-xs font-bold">OPPONENT</div>
                             <div className={`w-20 h-20 bg-slate-800 rounded-2xl flex items-center justify-center text-4xl border-2 ${opponentChoice && bothChose ? 'border-indigo-500' : 'border-slate-700'}`}>
                                 {/* Only show opponent choice if both have chosen */}
                                 {opponentChoice && bothChose ? (choices.find(c=>c.id===opponentChoice).icon) : (opponentChoice ? '‚úîÔ∏è' : '?')}
                             </div>
                         </div>
                    </div>

                    <div className="mb-8 h-12 flex items-center justify-center">
                        {bothChose ? (
                            <div className="flex flex-col items-center gap-2">
                                <div className="text-3xl font-bold text-white animate-bounce">{getResultText()}</div>
                                <button onClick={resetRound} className="text-xs bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-full text-white">Play Again</button>
                            </div>
                        ) : (
                            <div className="text-slate-400 animate-pulse">
                                {!gameState?.player2 ? "Waiting for opponent..." : 
                                 !myChoice ? "Make your choice!" : "Waiting for them..."}
                            </div>
                        )}
                    </div>

                    {/* Controls */}
                    <div className={`flex gap-4 transition-opacity duration-300 ${bothChose || !gameState?.player2 ? 'opacity-50 pointer-events-none' : 'opacity-100'}`}>
                        {choices.map((choice) => (
                            <button
                                key={choice.id}
                                onClick={() => makeMove(choice.id)}
                                className={`w-20 h-20 bg-slate-800 rounded-2xl text-4xl shadow-lg border-2 transition-all transform hover:scale-110 active:scale-95 flex items-center justify-center
                                    ${myChoice === choice.id ? 'border-pink-500 bg-slate-700' : 'border-slate-700 hover:border-pink-400'}
                                `}
                            >
                                {choice.icon}
                            </button>
                        ))}
                    </div>
                </div>
            );
        };
        
        // ==========================================
        // PAGE: APP COMPONENT
        // ==========================================
        const App = () => {
            const [view, setView] = useState('home'); 
            const [user, setUser] = useState(null);
            const [showChangelog, setShowChangelog] = useState(false);
            const [fbReady, setFbReady] = useState(false);

            useEffect(() => {
                // Poll for Firebase modules
                const initAuth = async () => {
                    if (window.firebaseModules && typeof __firebase_config !== 'undefined') {
                        try {
                            const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore } = window.firebaseModules;
                            const firebaseConfig = JSON.parse(__firebase_config);
                            const app = initializeApp(firebaseConfig);
                            
                            fb.auth = getAuth(app);
                            fb.db = getFirestore(app);
                            if (typeof __app_id !== 'undefined') fb.appId = __app_id;
                            
                            fb.initialized = true;
                            setFbReady(true);

                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(fb.auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(fb.auth);
                            }
                            
                            onAuthStateChanged(fb.auth, setUser);
                        } catch(e) { console.error("FB Init:", e); }
                    } else {
                        setTimeout(initAuth, 200);
                    }
                };
                
                initAuth();
            }, []);
            
            useEffect(() => {
                if (!localStorage.getItem('changelog_v4')) {
                    setShowChangelog(true);
                    localStorage.setItem('changelog_v4', 'true');
                }
            }, []);

            const NavButton = ({ target, icon: Icon, label }) => (
                <button 
                    onClick={() => setView(target)}
                    className={`flex flex-col items-center gap-1 p-2 ${view === target ? 'text-pink-400' : 'text-slate-500 hover:text-slate-300'}`}
                >
                    <Icon size={24} />
                    <span className="text-xs">{label}</span>
                </button>
            );

            return (
                <div className="bg-slate-950 min-h-screen text-slate-200 font-sans selection:bg-pink-500 selection:text-white relative overflow-hidden">
                    <StarBackground />
                    
                    {/* Changelog Modal */}
                    {showChangelog && (
                        <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in">
                            <div className="bg-slate-900 border border-pink-500 rounded-2xl p-6 max-w-sm w-full text-center shadow-2xl relative">
                                <button onClick={() => setShowChangelog(false)} className="absolute top-2 right-2 text-slate-500 hover:text-white"><X size={20}/></button>
                                <h2 className="text-xl font-bold text-pink-400 mb-2">‚ú® Update Log</h2>
                                <p className="text-xs text-slate-500 font-mono mb-4">Dec 29, 2025</p>
                                <div className="text-left text-sm text-slate-300 space-y-2 mb-6 bg-slate-800/50 p-4 rounded-lg">
                                    <ul className="list-disc pl-4 space-y-1">
                                        <li><b>Added:</b> Blooming Stargazer Lily üå∏</li>
                                        <li><b>Also added:</b> Poems & RPS Gameüß∏</li>
                                    </ul>
                                </div>
                                <button onClick={() => setShowChangelog(false)} className="w-full py-2 bg-pink-600 hover:bg-pink-500 text-white rounded-lg font-bold">Cool, thanks!</button>
                            </div>
                        </div>
                    )}
                    
                    <main className="relative z-10 h-[calc(100vh-80px)] overflow-y-auto pb-20 scrollbar-hide">
                        {view === 'home' && (
                            <div className="flex flex-col items-center justify-center min-h-full p-8 text-center">
                                <div className="mb-6 relative">
                                    <div className="absolute inset-0 bg-pink-500 blur-3xl opacity-20 rounded-full"></div>
                                    <Cat size={80} className="text-slate-100 relative z-10" />
                                </div>
                                <h1 className="text-4xl md:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-300 via-purple-300 to-indigo-300 mb-4 tracking-tight">
                                    The Black Cat's (you)<br/>Midnight Picnic
                                </h1>
                                <p className="text-slate-400 max-w-md mb-8">
                                    A collection of mini-stuff for you &lt;3.
                                </p>
                                <button 
                                    onClick={() => setView('poems')}
                                    className="px-8 py-3 bg-white text-black font-bold rounded-full hover:bg-pink-200 transition-colors flex items-center gap-2"
                                >
                                    <Play size={16} fill="black" /> Enter World
                                </button>
                            </div>
                        )}

                        {/* Hidden Games to preserve state */}
                        <div className={view === 'game' ? 'h-full w-full' : 'hidden'}>
                            <PicnicGame />
                        </div>
                        <div className={view === 'rpg' ? 'h-full w-full' : 'hidden'}>
                            <RPGGame isActive={view === 'rpg'} />
                        </div>

                        {view === 'study' && <Pomodoro />}
                        {view === 'calm' && <ThoughtShrinker />}
                        {view === 'facts' && <ConstellationGallery />}
                        {view === 'letter' && <LoveLetter />}
                        {view === 'poems' && <DailyPoem />}
                        {view === 'rps' && <RockPaperScissors user={user} />}
                    </main>

                    <nav className="fixed bottom-0 left-0 w-full bg-slate-900/90 backdrop-blur-md border-t border-slate-800 z-50 h-20 pb-2">
                        <div className="flex justify-evenly items-center h-full w-full max-w-lg mx-auto px-2">
                            {/* Group: Home */}
                            <NavButton target="home" icon={Tent} label="Camp" />
                            
                            <div className="w-px h-6 bg-white/10"></div>
                            
                            {/* Group: Focus/Calm */}
                            <NavButton target="study" icon={Book} label="Study" />
                            <NavButton target="calm" icon={Cloud} label="Calm" />
                            <NavButton target="rps" icon={Scissors} label="RPS" />

                            <div className="w-px h-6 bg-white/10"></div>
                            
                            {/* Group: Content */}
                            <NavButton target="poems" icon={Feather} label="Poems" />
                            <NavButton target="facts" icon={Star} label="Stars" />
                            <NavButton target="letter" icon={Heart} label="Msg" />
                        </div>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>